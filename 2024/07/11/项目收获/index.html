<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>项目收获 | Calyee`Blog</title><meta name="keywords" content="MyBatis,项目,设计模式,游标翻页,模板数据库,MySQL"><meta name="author" content="Calyee"><meta name="copyright" content="Calyee"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="项目收获"><meta name="application-name" content="项目收获"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="项目收获"><meta property="og:url" content="https://blog.calyee.top/2024/07/11/%E9%A1%B9%E7%9B%AE%E6%94%B6%E8%8E%B7/index.html"><meta property="og:site_name" content="Calyee`Blog"><meta property="og:description" content="刮开看看：此篇文章旨总结在各种项目中学习到的点 Git常用命令这个就应该被置顶，在你看到这个的时候你可能会想，Git不是直接使用IDEA提供图形化界面就可以了吗？我想说是的，但是在我提交修复前端Bug的时候，VsCode我就没习惯他的插件提交：故 笔者列出来了常用的命令 12345678910111"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://pic.imge.cc/2024/07/12/669124e9199ae.webp"><meta property="article:author" content="Calyee"><meta property="article:tag" content="记录一个有趣的点滴,仇仇仇,博客,calyee,追求充实，分享快乐"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://pic.imge.cc/2024/07/12/669124e9199ae.webp"><meta name="description" content="刮开看看：此篇文章旨总结在各种项目中学习到的点 Git常用命令这个就应该被置顶，在你看到这个的时候你可能会想，Git不是直接使用IDEA提供图形化界面就可以了吗？我想说是的，但是在我提交修复前端Bug的时候，VsCode我就没习惯他的插件提交：故 笔者列出来了常用的命令 12345678910111"><link rel="shortcut icon" href="/favicon.svg"><link rel="canonical" href="https://blog.calyee.top/2024/07/11/%E9%A1%B9%E7%9B%AE%E6%94%B6%E8%8E%B7/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: {"enable":true,"title":"与众多博主无限进步","addFriendPlaceholder":"昵称（请勿包含博客等字样）：\n网站地址（要求博客地址，请勿提交个人主页）：\n头像图片url（请提供尽可能清晰的图片，我会上传到我自己的图床）：\n描述：\n站点截图（可选）：\n"},
  peoplecanvas: undefined,
  postHeadAiDescription: undefined,
  diytitle: {"enable":true,"leaveTitle":"再看看嘛！","backTitle":"欢迎回来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"朋友你好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://comment.calyee.top/',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: {"apiurl":"https://friend.calyee.top/"},
  navMusic: true,
  mainTone: {"mode":"both","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: {"appId":"K3TD0AWLWP","apiKey":"b835c5138cfaf80ad103333b2a8b0a0b","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: Calyee","link":"链接: ","source":"来源: Calyee`Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: {"enable":true,"delay":100,"shiftDelay":200},
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Calyee`Blog',
  title: '项目收获',
  postAI: '',
  pageFillDescription: 'Git常用命令, Arthas, 简介, 背景, Arthas（阿尔萨斯）能为你做什么？, IDEA 插件辅助, 使用, 使用命令, 游标翻页, 深翻页问题, 游标翻页解决深翻页问题, 工具类封装, 封装Starter, AQS, AQS 类定义以及 Node 节点数据结构说明, 从ReentrantLock的非公平独占锁实现来看AQS的原理, 抽象类的使用(最佳实践), 请求上下文RequestHolder, 聊天项目中的工厂模式和策略模式组合, 实际开发中的工厂加策略模式, 工厂模式 1(策略抽象一层), 工厂模式 2(策略抽象两层 可拓展性更强), 小总结, MyBatis, MyBatisPlus saveBatch 优化, Mybatis 插件机制Interceptor与InnerInterceptor, 关系型数据库实现类动态字段数据库, 指标表, 填报表单, 填报数据, 数据翻转与 Stream 流操作, 渲染分析与翻转, 似山代码, 替换方案, Excelx2FWord 数据相关, EasyExcel, Apache poi, 类加载读取resource, XxlJob定时任务, 数据同步方案, 动态数据源, XxlJob 正轨, 异步任务, CompletableFuture, ThreadPoolTaskExecutor 线程池, ElasticSearch, 依赖, EsUtil, EsInit, 分页查询 + 高亮 + 内联查询, 收集内联条件, 结果集查询, 处理高亮, 分页对象封装, 可视化 Edge 小插件, 问题项, 做聊天项目遇到一些题, ThreadLocal, Redis与MySQL的数据一致性, 进程 线程 多线程, 什么时候使用多线程什么时候使用多进程？, 如何查看死锁？判断发生了死锁？, 项目部署上去了有用过日志吗？怎么在服务器查看日志？, 查看Java进程相关刮开看看此篇文章旨总结在各种项目中学习到的点常用命令这个就应该被置顶在你看到这个的时候你可能会想不是直接使用提供图形化界面就可以了吗我想说是的但是在我提交修复前端的时候我就没习惯他的插件提交故笔者列出来了常用的命令创建新分支分支名更新本地远程分支情况查看目前的所有分支切换分支分支名拉取远程代码更新分支名合并本地分支到当前本地分支指从合并到当前分支可切换或者直接指定两个分支不常用官网神级调试工具笔者目前还在了解中笔记待更新简介是一款线上监控诊断产品通过全局视角实时查看应用内存线程的状态信息并能在不修改应用代码的情况下对业务问题进行诊断包括查看方法调用的出入参异常监测方法执行耗时类加载信息等大大提升线上问题排查效率背景通常本地开发环境无法访问生产环境如果在生产环境中遇到问题则无法使用远程调试更糟糕的是在生产环境中调试是不可接受的因为它会暂停所有线程导致服务暂停开发人员可以尝试在测试环境或者预发环境中复现生产环境中的问题但是某些问题无法在不同的环境中轻松复现甚至在重新启动后就消失了如果您正在考虑在代码中添加一些日志以帮助解决问题您将必须经历以下阶段测试预发然后生产这种方法效率低下更糟糕的是该问题可能无法解决因为一旦重新启动它可能无法复现如上文所述旨在解决这些问题开发人员可以在线解决生产问题无需重启无需代码更改作为观察者永远不会暂停正在运行的线程阿尔萨斯能为你做什么是开源的诊断工具深受开发者喜爱当你遇到以下类似问题而束手无策时可以帮助你解决这个类从哪个包加载的为什么会报各种类相关的我改的代码为什么没有执行到难道是我没分支搞错了遇到问题无法在线上难道只能通过加日志再重新发布吗线上遇到某个用户的数据处理有问题但线上同样无法线下无法重现是否有一个全局视角来查看系统的运行状况有什么办法可以监控到的实时运行状态怎么快速定位应用的热点生成火焰图怎样直接从内查找某个类的实例插件辅助下载插件先比如我们现在有一个代码为我需要对其进行监控调用我们可以右键有然后可以看到有等命令点击之后就会在剪切板上有一个快捷命令然后在运行的输入即可使用把拉取下来然后启动然后就会让我们选择诊断的进程选择对应进程例如我们输入就可以了使用命令总体面板线程内存环境变量高线程堆栈死锁反编译类用于看看自己的代码提交没用于得到静态属性的值直接修改线上属性的值救急以下配合插件查看一个方法的入参出参查看一个方法的栈调用耗时查看一个方法的栈调用主要用于查看方法哪里调用项目监控接口入参出参耗时并且回放接口调用游标翻页游标翻页应对复杂变换的列表深翻页问题我们在一般的后端开发场景中比如管理系统常常都会有分页条她可以指定一页的条数以及快捷的调整页码现在我们假如前端想查看第页的内容传的值为那么对于数据库的查询语句就是其中代表需要跳过的条数代表跳过指定条数后往后需要再取的条数对应就是这样的一个效果需要在数据库的位置先读出条然后丢弃丢弃完条后再继续取条选用那么假如我们需要查询到条后的条数据那么前面的是不是都被没用的丢弃了我们经常需要定时任务全量去跑一张表的数据普通翻页去跑的话到后面数据量大的时候就会越跑越慢这就是深翻页带来的问题游标翻页解决深翻页问题游标翻页可以完美的解决深翻页问题依赖的就是我们的游标即针对的游标翻页我们需要通过快速定位到指定记录意味着游标必须添加索引下面这个示例就是游标翻页的例子我们需要查询的数据我们通过索引直接定位到条的位置然后再取十条则是我们想要的只要这个字段有索引就能直接定位到这个字段然后去条记录以后无论翻页到多大通过索引直接定位到读取的位置效率基本是一样的这个就是我们的游标这就是游标翻页前端之前传的字段改成了字段是上一次查询结果的位置作为下一次查询的游标由后端返回那么我们则需要定义示例下面的游标类页大小游标初始为后续请求附带上一次翻页的游标游标翻页返回游标下次翻页带上这参数是否最后一页数据列表工具类封装第一次游标字段类型额外条件游标条件游标方向取出游标判断是否最后一页字段映射反序列化缓存获取表达式返回类型获取信息失败无法加载类获取表达式的参数类型获取信息失败无法加载类解析表达式加了缓存该缓存可能会在任意不定的时间被清除通过反射调用实现序列化接口函数对象的方法从而拿到该对象中包含了表达式的所有信息需要解析的对象返回解析后的结果封装虽然在前面的篇章我们也封装了一次但是现在是实战此时我们需要封装一个的支持自定义切换简略仅提供思路众所周知封装一个我们需要提供一个给那么肯定需要创建这样就会扫描到这个自动配置类然后加载配置自动配置类读取配置文件是否开启存储对象服务器类型访问端点集群时需提供统一入口用户名密码存储桶仅仅列出上述两点对于其他的文件大同小异仅有当前两项是重点一个是自动配置类一个是读取配置文件其中还有一些注解需要理解一些可以参见章节类定义以及节点数据结构说明众所周知是的简称然后他有两个重要的属性它代表着一个同步状态他在不同的实现子类中有不同的实现例如在中代表当前共享资源已经被加锁则代表被多次加锁然后对于的操作他有三个方法其实我们可以看做全称是是一种用于在多线程环境下实现同步功能的机制操作包含三个操作数内存位置预期数值和新值的实现逻辑是将内存位置处的数值与预期数值想比较若相等则将内存位置处的值替换为新值若不相等则不做任何操作节点其中节点结构如下双向链表同步队列对于节点做如下解释当一个线程拿不到锁的时候他就会被添加到节点的双向链表中其中与指针是用于标记阻塞线程节点的头尾指针中间的节点其实就是节点可以理解为队列一个一个的取处理完成则去除当前线程节点然后指向下一个节点如果执行完毕后他对应的然后释放锁此时队列中排队等待的线程则会按连接顺序依次出队列此时不是说释放锁了他就直接拿到锁他还是像之前没有拿到锁一样通过进行修改值然后拿锁假设成功持有锁了那么维护的队列就会让队头元素出队然后刚刚获取锁的线程成为头结点然后一直重复入队出队的操作持有锁修改为释放锁修改为从的非公平独占锁实现来看的原理通过了解类我们可以知道他是一个抽象类其中他还有一个父类目前持有独占锁的线程此项用于设置上述属性的值此项用于获取上述属性的值其中中比较重要的成员变量有头指针尾指针在前一节已经解释过超时中断其中中还有一个静态内部类代码块共享共享锁排他独占锁初始化下一个节点需要被唤醒下一个节点需要被唤醒初始化为枚举值使用上面的值前驱节点后继节点在条件队列指向的是下一个指针在同步队列中指向的是我们当前节点想获取的是共享锁还是排他锁抽象类的使用最佳实践当前抽象类为批量缓存先抽象接口获取单个获取批量修改删除单个修改删除多个在抽象类抽象的原方法获取用户信息盘路缓存模式批量组装批量发现差集还需要更新的批量加载回抽象后的方法因为后面都需要复用这样的方法所以抽取公共的类型的批量缓存框架防御性编程去重组装批量差集计算不足的重新加载进批量组装最后的结果其中见开发小手册开发小手册样例请求上下文对于登录的用户我们会将设置为请求属性在中统一收集聊天项目中的工厂模式和策略模式组合例如我们现在有一个需求对于传入的不同数据进行不同的处理比如发消息他聊天框可以发送不同类型的消息这个是不是就可以用策略模式工厂模式进行推送处理即我需要对不同的数据进行不同的处理那么就可以使用这个组合我们先定义一个抽象类模板消息处理器抽象类消息类型统一校验子类扩展校验统一保存子类扩展保存需要保存的逻辑展示消息被回复时展示的消息会话列表展示的消息提供一个实现类样例表情表情包然后我们需要提供一个工厂创建场景对象使用发送消息这里发布消息发送事件实际开发也能用到笔者在实习的时候就用上了一步一步改造场景我需要对不同数据进行不同的处理什么个不同法比如这个数据需要求和另外一个需要求平均还有需要求时间最早的等等等场景求和平均实际开发中的工厂加策略模式笔者扩展的工厂模式策略抽象一层对于固定的模版比如处理的数据他是固定的下面图例为工厂的模式那么我们可以定义一个模版数据处理抽象类获取模式类型策略例如我们在此是求和策略当然也可以求平均求和处理当前处理的数据不能为空该类型暂不支持工厂类型我们需要提供方法给他进行调用计算其他的枚举拿到具体的策略没有对应的处理策略使用的表现形式体现为我们需要手动调用这种方式常常用于策略模式很多的情况这一步我们需要手动调用工厂模式一总结对于策略固定且策略较多的情况我们可以使用此类型即我们模版可以使用同一个然后具体实现具体分析通过给对象然后从工厂生产出具体的策略然后自己调用工厂模式策略抽象两层可拓展性更强当前模式适用于更复杂的场景例如工厂模式出场对于当前的策略定义基础抽象父类模版上层基础模版分区抽象模版基础数据处理抽象类基础数据处理抽象模版方法获取模式类型数据处理对于时间的运算抽象模版方法获取模式类型处理年份数据说明时间与数据应该一一对应例如时间对应数据对应策略具体实现仅给出一个案例求和处理当前处理的数据不能为空该类型暂不支持工厂方法简单基础数据运算年份数据运算暂时没有该处理没有对应的处理策略测试用例模拟查询到的数据数据处理模拟查询到的数据数据处理通过测试案例可以知道我们现在的话不是通过自己去调用方法去处理了而是直接传入对象及其行为直接返回数据处理结果即可小总结对于我们是采用的直接回送策略然后自己进行处理然后模版是一致的对于我们采用的是传入对象我们直接内部处理让调用者不需要关心里面具体的逻辑传入对象即可然后抽象是多层的我们可以通过这个定义某一系列的行为然后去实现优化设置批量插入下面我们为数据库的连接加上的属性再测试批量加入的耗时插件机制与在中插件机制提供了强大的扩展能力在最终执行之前提供了四个拦截点支持不同场景的功能扩展例如我们需要对查询出来的数据进行解密数据库保存的是加密信息然后我们可以定义一个注解取修饰字段假如字段被这个注解修饰的话那么后续的操作我们则需要进行加密解密解密基于逐一解密基于这个方法其实就是判断字段是否有我们自定义的注解修饰加密和完整性计算拦截器目前完整性计算只支持自带的变量占位符正则如果查询条件是加密数据列那么要将查询条件进行数据加密例如手机号加密存储后按手机号查询时先把要查询的手机号进行加密再和数据库存储的加密数据进行匹配具体逻辑不列出可查看解密逻辑新增更新数据时如果包含隐私数据则进行加密还有个问题进行修改时如果传过来的实体类的属性有属于脱敏的数据那么这个脱敏的数据没有被修改的情况下需要被识别出来不更新到数据库具体逻辑不列出可查看解密逻辑关系型数据库实现类动态字段数据库为什么需要用到动态数据库呢场景我们有一个需求就是以前端的视角来描述前端的需求需要动态渲染指标列假如后端多了一个指标那么前端也需要对应上去也多一个列去动态渲染这个时候对于普通的关系型数据库是做不到的因为普通的我们指标字段是定下来的此时的这个老传统数据结构是解决不了这个需求的那么我和同事想到了可以使用动态模版数据库什么是动态模版数据库其实就是通过定义模版表单然后具体的表单对应具体的字段指标然后数据绑定表单与具体的指标列那么因为动态数据库对应的数据一次性填的是一个指标的项然后到最后查询查询出来的却是列级别数据这个时候与前端渲染模式有点出入那么这个时候我们需要使用到数据翻转那么表结构可以参考如下指标表键指标名称上级指标是否可用排序字段填报表单键表单表单描述表单二级指标表单二级指标名字填报年份用于统计表单发表状态发布则不可再选具体业务具体分析表单是否可用表单是否可编辑表单发布单位表单发布单位名当前的二级指标指的是可以理解为一共就只有三个指标一级指标就是一级路由然后展开就是二级指标路由二级路由对应绑定了页面页面渲染的是三级指标填报数据键填报表单填报表单名称填报单位填报人指标三级指标指标值例如数据状态为填报的数据可能这个表部分地方设计不合理但是大概步骤是这样的如果有人看到或者发现有啥建议可以在下面评论笔者会第一时间回复虽然应该没人看数据翻转与流操作渲染分析与翻转对于我们现在有一个这样的要求就是我们的数据在第一次处理完成之后是这样的对应的指标列即模版数据库的一行数据指标其他描述指标其他描述这个一行是指例如我们在中一次填报一行的数据其中一行就对应一个指标值此时可以填报多列多个指标只不过在数据库中不在同一行存储可能这个多个指标有点抽象那么我们在此场景仅理解为一个列即可上面那个表格也许在数据库中我们通过联表查询后是这样指标其他描述指标其他描述那么对应中我们在通过框架查询后转换为后他就是对应一个其中很容易知道属性有此时我们可以通过流处理数据把他变成一个然后就变成一个了是我们根据年份分组的就是剩下的字段此时就是笔者第一次列出来的表格如果是这样的结构返回给前端是这样的指标其他描述指标其他描述查询成功因为前端是渲染表格我们这样的话返回的是一个列的数据就是他们本来就是属于一个指标下的按照逻辑来说一个指标下的数据我们应该这样显示指标其他描述指标这是本年度指标二数据下的值前面没有列出指标其他描述指标描述查询成功就是行级数据这样才是正常的渲染逻辑一次性渲染一行第一次渲染年度的一指标与二指标的数据第二次渲染第二行年度的数据对于这种列数据转换行数据我们同样是使用操作前面那个渲染结果结构显然就是的结构只不过是对应多个的情况那么即可定义为我们需要的渲染内部结构按照年度分组第一层遍历每一个年份组数据处理逻辑第二层处理的结构处理里面的值最后的总体结构有此年份数据似山代码开始写似山了处理不同的长度填充则需要补充空指标对应年份即补充标准创建指标集合的流对每个指标名进行处理获取当前年份的内部数据列表的流过滤出匹配指标名的数据按照补充标准找到第一个匹配的数据则不需要处理使用原有数据即可如果没有找到则创建并返回一个新的实例设置指标名补充空数据将结果收集成列表替换方案改用传统循环替换代码如下减少了流的使用它需要频繁创建流对象采用迭代器对于业务无关紧要的代码提取使用循环的版本避免了内部流操作的多次迭代减少了函数调用并且直接操作了数据结构这通常会带来更好的性能在某些情况下特别是在处理复杂的数据转换和操作时流可以提供更简洁更易读的代码但是对于性能敏感的操作特别是在数据量很大时传统的循环可能是一个更好的选择对应每一个结果指标标准数据符合条件则构造空数据结果封装建议使用手动设置方法提取链式不建议再优化不使用链式调用创建对象采用手动填充数据并且声明为静态类数据相关可以使用阿里的这里什么都没有工具类模板填充方式导出模板注意用来表示你要用的变量如果本来就有特殊字符用代替代表普通变量代表是的变量响应数据行列表的变量普通数据变量文件名填充模板路径这里需要设置不关闭流开启写入数据填充模板参数结束自定义表头导出响应文件名名头数据列表哦泛型保证和类型的一致性写入失败的情况输出不要自动关闭交给自己处理基于长度自动适配最大宽度避免类型丢失精度设置和写在最后的原因是避免报错时响应已经被修改了将列表以响应给前端响应文件名名头数据列表哦泛型保证和类型的一致性写入失败的情况输出不要自动关闭交给自己处理基于长度自动适配最大宽度避免类型丢失精度设置和写在最后的原因是避免报错时响应已经被修改了不要自动关闭交给自己处理自动去除空格如果是需要创建直接使用下面这个他是创建很棒的文档类加载读取有用可以与上面的导出生成相结合如果是使用模板填充的方式那么需要保存模板我们则需要读取模板文件如果传统的放入代码文件夹我们会发现是打包不了的笔者血的教训五年则需要采用下面的方式类加载读取文件项目读取目录下的文件的种方式总结阿里云开发者社区总结使用方法这是一种通用的方式可以适用于大多数情况目录下的文件可以使用提供的类来加载文件这种方式比较简单不需要提供完整的文件路径需要注意的是使用不同的方式需要了解其适用的场景和使用方法对于不同的项目和需求可能需要选择不同的方式定时任务数据同步方案今天给我布置了一个数据同步的任务其实要做到数据同步方案还是挺多的我们可以使用需要内嵌代码发布监听事件自带的定时任务不需要内嵌代码监听的日志需要开启的日志需要读取二进制文件可以用但是不是很友好对于笔者当前的场景在笔者当场景适合不在原有的业务逻辑上新增代码我们只需要定时去轮询数据库的数据对于仅仅需要操作少量数据如果你是可能这个轮询数据库的操作不是很适合对于笔者的项目当然合适反正用户量也不多定时同步完全够了我们只需要做到增量同步全量同步即可动态数据源具体如何切换参考我们一般在业务层上控制切换的切面如果是这样的设置我们在注入该服务的时候就是用的从数据源当然还可以在方法上面去使用该注解例如提供的样例当前执行顺序以局部为主类上面决定里面默认数据源方法上决定该局部的数据源正轨具体按照参考分布式任务调度平台下载我们直接把源码拉取过来即可在前面的所有步骤都完成之后即到官网的步骤时我们可以开始创建自己的模块在把代码拉取下来之后我们的项目结构是现在这个样子的网页调度中心公共依赖我们的任务模块我们自己创建的业务怎么创建分布式任务调度平台模式方法形式可参考示例执行器中的如下到这里了那么剩下的其实就和普通的项目开发业务逻辑一模一样的我们要操作数据库那么先定义实体然后去数据访问以及业务处理但是这里我们可以用类似于工厂模式的方法去实现动态的对象处理假如我们的是这样的系统用户数据同步开始接收到参数可以增加参数执行系统用户数据同步结束其实就是定义的一个抽象接口具体实现其中这个就是具体业务实现类的抽象接口父类可以理解成为这个结构具体业务具体业务我们观察到这个他有一个方法规范为那么我们在使用的时候在实现完的时候也得实现这样的话在后续继承实现该类的时候我们只需要实现父类处理业务的接口即可具体业务项目结构如下笔者的场景数据同步那么对于源数据其实就是原始数据主数据对于目标数据处理那么不就是把主数据同步到目标数据吗只不过拉取数据的规范在源数据里面实现了对于业务其实就是定义控制类似于我们可以在端控制任务的执行以及参数的传入根据不同的需求执行不同的业务定义异步任务第一次推送执行时间毫秒在上述案例中我们在批量更新插入的时候可能不是对于一个数据源当前部分应该与上一个部分以及上上个部分相结合优化多数据源实现异步多批量插入一个任务的执行不会阻塞另外一个当前方案笔者测试未通过线程池第一次推送执行时间毫秒还是这个熟悉依赖工具类获取实体类列名创建索引库需要创建一个实体类其中配置实体类和文档的映射关系使用注解配置创建索引库设置信息只添加索引创建索引库添加索引的字段映射设置信息删除索引库那么这个其实就是有点类似于那一套其中就是实现的他原封装的操作到这里基本结构已经没什么问题了分页查询高亮内联查询例如我现在有一个需求我需要查询一页二十条数据并且我需要查询的字段为其中查询出来的数据得高亮那么对于构建复杂的查询笔者是推荐使用结合那么大体结构我们可以这样构造最后查询条件设置分页参数收集内联条件内条件查询查询字段设置高亮颜色例如这个可以更换为其他的具体见官网小结对于需要构造复杂的查询我们可以使用套进行筛选然后条件补充完之后再吧当前内条件给封装到外条件中最后在封装到原生查询条件中查询条件收集高亮条件收集根据得分排序结果集查询此时则不能使用旧的那个即实现了的那个类因为它在高版本已经被废弃了我们可以采用注入然后所以这个模版方法进行查询处理高亮高亮其实就行遍历我们刚刚拿到的然后里面会有一个高亮的内容可以理解为我这个字段是否参与了高亮的操作结果列表封装分页对象封装刚刚处理完高亮的结果可视化小插件去拓展商店搜索即可下载连接即可使用问题项如果你的实体字段日期属性使用的是那么在格式化的时候会出现异常解决方案改为对于的数据同步问题我们有两个方案一个是前端对于一个数据库操作发送两个请求一个是操作数据库一个是对于刚刚的数据进行同步后端操作我们可以在需要数据同步的方法里同步进行和操作很显然比较合适因为前端可能会因为网络波动而导致第二个请求失效做聊天项目遇到一些题的内部类为的为弱引用为强引用面试题为什么会内存泄漏与的数据一致性先删后更先删除缓存后更新数据库可以采用的方案延迟双删先更后删先更新数据库后删除缓存采用中间添加一个消息中间件数据库生产消息消息中间件消费消息缓存推送需要删除缓存的消息消费推送的消息更新进程线程多线程进程是系统运行的基本单位例如等他运行其实就可以看作成进程从的运行到结束的过程可以看作成进程的创建到消亡的过程其中进程可以包含很多个线程组成线程进程和线程很像但是线程是一个比进程更小的执行单位什么时候使用多线程什么时候使用多进程多线程对于密集型因为需要大量的操作在进行操作时候处于空闲状态那么可以交给其他的线程去执行多进程对于密集型他需要大量的计算那么可以充分利用多进程进行计算提升效率多核当需要并行计算的时候也可以使用多进程如何查看死锁判断发生了死锁自带的图形化界面进程项目部署上去了有用过日志吗怎么在服务器查看日志动态查看日志查看最后行日志查看最后行日志引申如果需要查看某进程例如需要查看的进程如果需要不挂起运行然后后台可以指定日志如需检查使用和特定路径通过文件系统查看信息查看信息效果内存使用特定路径以人类可读的单位显示例如以为单位显示查看进程相关查看后端服务对应的进程生成线程快照并保存为文件进程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-07 15:56:32',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 8 || hour >= 22
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="baidu-site-verification" content="codeva-DOS62mgFQf" /><link rel="stylesheet" href="/css/imgloaded.css?1"><link rel="stylesheet" href="/css/home.css?1"><link rel="stylesheet" href="/css/costom1.css?1"><link rel="stylesheet" href="/css/todolist.css?1"><link rel="stylesheet" href="/css/welcome.css?1"><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://s2.loli.net/2024/03/07/tFEYfQsaBHWV14x.webp" referrerpolicy="no-referrer"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="http://blog.calyee.top/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">直达链接</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/Yikoutian1/" title="Github"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" referrerpolicy="no-referrer" alt="Github"/><span class="back-menu-item-text">Github</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://chat.calyee-blog.top/" title="ChatGPT"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://freelogopng.com/images/all_img/1681038242chatgpt-logo-png.png" referrerpolicy="no-referrer" alt="ChatGPT"/><span class="back-menu-item-text">ChatGPT</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://calyee-image.pages.dev/" title="Images"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic.molunerfinn.com/picgo/docs/logo-150.png" referrerpolicy="no-referrer" alt="Images"/><span class="back-menu-item-text">Images</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.calyee.top/" title="个人首页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog.calyee.top/favicon.svg" alt="个人首页"/><span class="back-menu-item-text">个人首页</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">工具</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.iconfont.cn/" title="阿里巴巴图标库"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://api.iowen.cn/favicon/www.iconfont.cn/.png" referrerpolicy="no-referrer" alt="阿里巴巴图标库"/><span class="back-menu-item-text">阿里巴巴图标库</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://cli.im/" title="草料二维码"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://ts4.cn.mm.bing.net/th?id=ODLS.28ebe3ec-525b-4152-bbd7-ec81168c5e0f&amp;w=32&amp;h=32&amp;qlt=90&amp;pcl=fffffa&amp;o=6&amp;pid=1.2" referrerpolicy="no-referrer" alt="草料二维码"/><span class="back-menu-item-text">草料二维码</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Calyee`Blog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/games/"><i class="anzhiyufont anzhiyu-icon-keyboard faa-tada" style="font-size: 0.9em;"></i><span> 我的游戏</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="anzhiyufont anzhiyu-icon-copy faa-tada" style="font-size: 0.9em;"></i><span> 待办清单</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size: 0.9em;"></i><span> 我的装备</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/img/pay/wx.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/pay/wx.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/pay/zfb.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/pay/zfb.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Docker/" style="font-size: 1.05rem; color: rgb(118, 185, 26);">Docker<sup>1</sup></a><a href="/tags/Dubbo/" style="font-size: 1.05rem; color: rgb(79, 87, 4);">Dubbo<sup>1</sup></a><a href="/tags/Hexo%E9%AD%94%E6%94%B9/" style="font-size: 1.05rem; color: rgb(98, 158, 68);">Hexo魔改<sup>2</sup></a><a href="/tags/JVM/" style="font-size: 1.05rem; color: rgb(171, 172, 87);">JVM<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem; color: rgb(82, 23, 114);">Java<sup>6</sup></a><a href="/tags/Jenkins/" style="font-size: 1.05rem; color: rgb(21, 9, 174);">Jenkins<sup>1</sup></a><a href="/tags/MyBatis/" style="font-size: 1.05rem; color: rgb(177, 87, 38);">MyBatis<sup>2</sup></a><a href="/tags/MyBatisPlus/" style="font-size: 1.05rem; color: rgb(55, 158, 78);">MyBatisPlus<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 1.05rem; color: rgb(185, 63, 87);">MySQL<sup>1</sup></a><a href="/tags/Netty/" style="font-size: 1.05rem; color: rgb(157, 97, 14);">Netty<sup>2</sup></a><a href="/tags/Nginx/" style="font-size: 1.05rem; color: rgb(129, 165, 174);">Nginx<sup>1</sup></a><a href="/tags/RabbitMQ/" style="font-size: 1.05rem; color: rgb(34, 49, 185);">RabbitMQ<sup>1</sup></a><a href="/tags/Redis/" style="font-size: 1.05rem; color: rgb(111, 145, 169);">Redis<sup>1</sup></a><a href="/tags/Spring/" style="font-size: 1.05rem; color: rgb(84, 19, 173);">Spring<sup>2</sup></a><a href="/tags/SpringBoot/" style="font-size: 1.05rem; color: rgb(30, 117, 179);">SpringBoot<sup>1</sup></a><a href="/tags/SpringCloud/" style="font-size: 1.05rem; color: rgb(125, 61, 122);">SpringCloud<sup>2</sup></a><a href="/tags/SpringMVC/" style="font-size: 1.05rem; color: rgb(20, 21, 80);">SpringMVC<sup>1</sup></a><a href="/tags/SpringSecurity/" style="font-size: 1.05rem; color: rgb(33, 17, 76);">SpringSecurity<sup>1</sup></a><a href="/tags/Vue/" style="font-size: 1.05rem; color: rgb(156, 86, 98);">Vue<sup>1</sup></a><a href="/tags/WebSocket/" style="font-size: 1.05rem; color: rgb(95, 1, 110);">WebSocket<sup>2</sup></a><a href="/tags/Zookeeper/" style="font-size: 1.05rem; color: rgb(0, 189, 133);">Zookeeper<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 1.05rem; color: rgb(181, 23, 54);">分布式<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 1.05rem; color: rgb(12, 174, 62);">分布式锁<sup>1</sup></a><a href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" style="font-size: 1.05rem; color: rgb(186, 89, 8);">反向代理<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 1.05rem; color: rgb(27, 98, 115);">后端<sup>5</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem; color: rgb(173, 34, 117);">多线程<sup>1</sup></a><a href="/tags/%E5%AE%B9%E5%99%A8/" style="font-size: 1.05rem; color: rgb(111, 45, 191);">容器<sup>1</sup></a><a href="/tags/%E5%BA%95%E5%B1%82/" style="font-size: 1.05rem; color: rgb(198, 179, 5);">底层<sup>1</sup></a><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 1.05rem; color: rgb(178, 97, 133);">微服务<sup>1</sup></a><a href="/tags/%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem; color: rgb(25, 191, 108);">总结<sup>2</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 1.05rem; color: rgb(13, 34, 57);">模板数据库<sup>1</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 1.05rem; color: rgb(110, 97, 1);">消息队列<sup>1</sup></a><a href="/tags/%E6%B8%B8%E6%A0%87%E7%BF%BB%E9%A1%B5/" style="font-size: 1.05rem; color: rgb(147, 80, 52);">游标翻页<sup>1</sup></a><a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 1.05rem; color: rgb(100, 117, 84);">源码分析<sup>3</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem; color: rgb(55, 7, 97);">算法<sup>1</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 1.05rem; color: rgb(132, 104, 196);">线程池<sup>1</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 1.05rem; color: rgb(198, 166, 49);">设计模式<sup>2</sup></a><a href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" style="font-size: 1.05rem; color: rgb(196, 110, 150);">负载均衡<sup>2</sup></a><a href="/tags/%E9%A1%B9%E7%9B%AE/" style="font-size: 1.05rem; color: rgb(126, 84, 190);">项目<sup>3</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/12/"><span class="card-archive-list-date">十二月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div class="console-btn-item" id="consoleKeyboard" onclick="anzhiyu.keyboardToggle()" title="快捷键开关"><a class="keyboard-switch"><i class="anzhiyufont anzhiyu-icon-keyboard"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/" itemprop="url">项目</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/MyBatis/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>MyBatis</span></a><a class="article-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>项目</span></a><a class="article-meta__tags" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>设计模式</span></a><a class="article-meta__tags" href="/tags/%E6%B8%B8%E6%A0%87%E7%BF%BB%E9%A1%B5/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>游标翻页</span></a><a class="article-meta__tags" href="/tags/%E6%A8%A1%E6%9D%BF%E6%95%B0%E6%8D%AE%E5%BA%93/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>模板数据库</span></a><a class="article-meta__tags" href="/tags/MySQL/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>MySQL</span></a></span></div></div><h1 class="post-title" itemprop="name headline">项目收获</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-07-11T11:46:04.562Z" title="发表于 2024-07-11 11:46:04">2024-07-11</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-09-07T15:56:32.734Z" title="更新于 2024-09-07 15:56:32">2024-09-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">15k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>64分钟</span></span><span class="post-meta-separator"></span><span id="" data-flag-title="项目收获"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://pic.imge.cc/2024/07/12/669124e9199ae.webp" referrerpolicy="no-referrer"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.calyee.top/2024/07/11/%E9%A1%B9%E7%9B%AE%E6%94%B6%E8%8E%B7/"><header><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/" itemprop="url">项目</a><a href="/tags/MyBatis/" tabindex="-1" itemprop="url">MyBatis</a><a href="/tags/%E9%A1%B9%E7%9B%AE/" tabindex="-1" itemprop="url">项目</a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" tabindex="-1" itemprop="url">设计模式</a><a href="/tags/%E6%B8%B8%E6%A0%87%E7%BF%BB%E9%A1%B5/" tabindex="-1" itemprop="url">游标翻页</a><a href="/tags/%E6%A8%A1%E6%9D%BF%E6%95%B0%E6%8D%AE%E5%BA%93/" tabindex="-1" itemprop="url">模板数据库</a><a href="/tags/MySQL/" tabindex="-1" itemprop="url">MySQL</a><h1 id="CrawlerTitle" itemprop="name headline">项目收获</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Calyee</span><time itemprop="dateCreated datePublished" datetime="2024-07-11T11:46:04.562Z" title="发表于 2024-07-11 11:46:04">2024-07-11</time><time itemprop="dateCreated datePublished" datetime="2024-09-07T15:56:32.734Z" title="更新于 2024-09-07 15:56:32">2024-09-07</time></header><p>刮开看看：<psw>此篇文章旨总结在各种项目中学习到的点</psw></p>
<h2 id="Git常用命令"><a href="#Git常用命令" class="headerlink" title="Git常用命令"></a>Git常用命令</h2><p>这个就应该被置顶，在你看到这个的时候你可能会想，Git不是直接使用IDEA提供图形化界面就可以了吗？我想说是的，但是在我提交修复前端Bug的时候，VsCode我就没习惯他的插件提交：<br>故 笔者列出来了常用的命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建新分支</span></span><br><span class="line">git branch 分支名</span><br><span class="line"><span class="comment"># 更新本地远程分支情况</span></span><br><span class="line">git fetch origin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看目前的所有分支</span></span><br><span class="line">git branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换分支</span></span><br><span class="line">git checkout 分支名</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取远程代码更新</span></span><br><span class="line">git pull origin 分支名</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并本地分支到当前本地分支（master指从master合并到当前分支）</span></span><br><span class="line">git merge master      // rebase可切换merge</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者直接指定两个分支：（不常用）</span></span><br><span class="line">git merge master feature</span><br></pre></td></tr></table></figure>

<h2 id="Arthas"><a href="#Arthas" class="headerlink" title="Arthas"></a>Arthas</h2><p><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/#%E8%83%8C%E6%99%AF">Arthas 官网</a></p>
<p>神级调试工具，笔者目前还在了解中，笔记待更新</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://arthas.aliyun.com/images/arthas.png" referrerpolicy="no-referrer"></p>
<p>Arthas 是一款线上监控诊断产品，通过全局视角实时查看应用 load、内存、gc、线程的状态信息，并能在不修改应用代码的情况下，对业务问题进行诊断，包括查看方法调用的出入参、异常，监测方法执行耗时，类加载信息等，大大提升线上问题排查效率。</p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>通常，本地开发环境无法访问生产环境。如果在生产环境中遇到问题，则无法使用 IDE 远程调试。更糟糕的是，在生产环境中调试是不可接受的，因为它会暂停所有线程，导致服务暂停。</p>
<p>开发人员可以尝试在测试环境或者预发环境中复现生产环境中的问题。但是，某些问题无法在不同的环境中轻松复现，甚至在重新启动后就消失了。</p>
<p>如果您正在考虑在代码中添加一些日志以帮助解决问题，您将必须经历以下阶段：测试、预发，然后生产。这种方法效率低下，更糟糕的是，该问题可能无法解决，因为一旦 JVM 重新启动，它可能无法复现，如上文所述。</p>
<p>Arthas 旨在解决这些问题。开发人员可以在线解决生产问题。无需 JVM 重启，无需代码更改。 Arthas 作为观察者永远不会暂停正在运行的线程。</p>
<h3 id="Arthas（阿尔萨斯）能为你做什么？"><a href="#Arthas（阿尔萨斯）能为你做什么？" class="headerlink" title="Arthas（阿尔萨斯）能为你做什么？"></a>Arthas（阿尔萨斯）能为你做什么？</h3><p>Arthas 是 Alibaba 开源的 Java 诊断工具，深受开发者喜爱。</p>
<p>当你遇到以下类似问题而束手无策时，Arthas可以帮助你解决：</p>
<p>这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？<br>我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？<br>遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？<br>线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！<br>是否有一个全局视角来查看系统的运行状况？<br>有什么办法可以监控到 JVM 的实时运行状态？<br>怎么快速定位应用的热点，生成火焰图？<br>怎样直接从 JVM 内查找某个类的实例？</p>
<h3 id="IDEA-插件辅助"><a href="#IDEA-插件辅助" class="headerlink" title="IDEA 插件辅助"></a>IDEA 插件辅助</h3><p> IDEA 下载插件先 Arthas Idea</p>
<p>比如我们现在有一个代码为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addOrUpdate</span><span class="params">(TagModel tagModel)</span> &#123;</span><br><span class="line">    <span class="comment">// ---</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我需要对其进行监控调用</p>
<p>我们可以右键有Arthas Command，然后可以看到有 watch、trace 等命令 </p>
<p>点击之后就会在剪切板上有一个快捷命令</p>
<p>然后在运行的 Arthas 输入即可</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>把 arthas 拉取下来，然后启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar</span><br></pre></td></tr></table></figure>

<p>然后就会让我们选择诊断的 Java 进程，选择对应进程，例如 [1] my.jar，我们输入 1 就可以了。</p>
<h3 id="使用命令"><a href="#使用命令" class="headerlink" title="使用命令"></a>使用命令</h3><ol>
<li>dashboard 总体jvm面板 线程 jvm内存 环境变量</li>
<li>thead -n 高cpu线程堆栈 thead -b死锁</li>
<li>jad 反编译类 用于看看自己的代码提交没</li>
<li>getstatic 用于得到静态属性的值</li>
<li>ognl 直接修改线上属性的值 救急</li>
</ol>
<p>以下配合 idea 插件</p>
<ol>
<li>watch 查看一个方法的入参出参</li>
<li>trance 查看一个方法的栈调用耗时</li>
<li>stack 查看一个方法的栈调用 主要用于查看方法哪里调用<br>springboot项目</li>
<li>tt 监控接口入参出参耗时 并且回放接口调用</li>
</ol>
<h2 id="游标翻页"><a href="#游标翻页" class="headerlink" title="游标翻页"></a>游标翻页</h2><p>游标翻页<strong>应对复杂变换的列表</strong></p>
<h3 id="深翻页问题"><a href="#深翻页问题" class="headerlink" title="深翻页问题"></a>深翻页问题</h3><p>我们在一般的后端开发场景中，比如管理系统，常常都会有分页条。她可以指定一页的<strong>条数</strong>以及快捷的调整<strong>页码</strong>。</p>
<p>现在我们假如前端想查看第11页的内容，传的值为 pageNo&#x3D;11，pageSize&#x3D;10</p>
<p>那么对于数据库的查询语句就是：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span> limit <span class="number">100</span>,<span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>其中<code>100</code>代表需要跳过的条数，<code>10</code>代表跳过指定条数后，往后需要再取的条数。</p>
<p>对应就是这样的一个效果，需要在数据库的位置先读出100条，然后<strong>丢弃</strong>。丢弃完100条后，再继续取10条<strong>选用</strong>。</p>
<p>那么假如我们需要查询到100000条后的10条数据,  那么前面的是不是都被没用的丢弃了?</p>
<blockquote>
<p>我们经常需要定时任务全量去跑一张表的数据，普通翻页去跑的话，到后面数据量大的时候，就会越跑越慢，这就是深翻页带来的问题。</p>
</blockquote>
<h3 id="游标翻页解决深翻页问题"><a href="#游标翻页解决深翻页问题" class="headerlink" title="游标翻页解决深翻页问题"></a>游标翻页解决深翻页问题</h3><p>游标翻页可以完美的解决深翻页问题，依赖的就是我们的游标，即<code>cursor</code>。针对mysql的游标翻页，我们需要通过<code>cursor</code>快速定位到指定记录，意味着游标必须添加索引。</p>
<p>下面这个示例就是游标翻页的例子:  我们需要查询101-110的数据,  我们通过索引直接定位到100条的位置,  然后再取十条则是我们想要的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">100</span> <span class="keyword">order</span> <span class="keyword">by</span> id limit <span class="number">0</span>,<span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>只要id这个字段有索引，就能直接定位到101这个字段，然后去10条记录。以后无论翻页到多大，通过索引直接定位到读取的位置，效率基本是一样的。这个<code>id&gt;100</code>就是我们的游标，这就是<strong>游标翻页</strong>。</p>
<p>前端之前传的<code>pageNo</code>字段改成了<code>cursor</code>字段。<code>cursor</code>是上一次查询结果的位置，作为下一次查询的游标，由后端返回:</p>
<p>那么我们则需要定义示例下面的游标类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiModelProperty(&quot;页大小&quot;)</span></span><br><span class="line"><span class="meta">@Max(50)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiModelProperty(&quot;游标(初始为null,后续请求附带上一次翻页的游标)&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String cursor;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(&quot;游标翻页返回&quot;)</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CursorPageBaseResp</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;游标（下次翻页带上这参数）&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String cursor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;是否最后一页&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Boolean</span> <span class="variable">isLast</span> <span class="operator">=</span> Boolean.FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;数据列表&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; CursorPageBaseResp&lt;T&gt; <span class="title function_">init</span><span class="params">(CursorPageBaseResp cursorPage, List&lt;T&gt; list)</span> &#123;</span><br><span class="line">        CursorPageBaseResp&lt;T&gt; cursorPageBaseResp = <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;T&gt;();</span><br><span class="line">        cursorPageBaseResp.setIsLast(cursorPage.getIsLast());</span><br><span class="line">        cursorPageBaseResp.setList(list);</span><br><span class="line">        cursorPageBaseResp.setCursor(cursorPage.getCursor());</span><br><span class="line">        <span class="keyword">return</span> cursorPageBaseResp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CollectionUtil.isEmpty(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; CursorPageBaseResp&lt;T&gt; <span class="title function_">empty</span><span class="params">()</span> &#123;</span><br><span class="line">        CursorPageBaseResp&lt;T&gt; cursorPageBaseResp = <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;T&gt;();</span><br><span class="line">        cursorPageBaseResp.setIsLast(<span class="literal">true</span>);</span><br><span class="line">        cursorPageBaseResp.setList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;T&gt;());</span><br><span class="line">        <span class="keyword">return</span> cursorPageBaseResp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="工具类封装"><a href="#工具类封装" class="headerlink" title="工具类封装"></a>工具类封装</h3><p>CursorUtils</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CursorUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; CursorPageBaseResp&lt;Pair&lt;T, Double&gt;&gt; <span class="title function_">getCursorPageByRedis</span><span class="params">(CursorPageBaseReq cursorPageBaseReq, String redisKey, Function&lt;String, T&gt; typeConvert)</span> &#123;</span><br><span class="line">        Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples;</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(cursorPageBaseReq.getCursor())) &#123;<span class="comment">//第一次</span></span><br><span class="line">            typedTuples = RedisUtils.zReverseRangeWithScores(redisKey, cursorPageBaseReq.getPageSize());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            typedTuples = RedisUtils.zReverseRangeByScoreWithScores(redisKey, Double.parseDouble(cursorPageBaseReq.getCursor()), cursorPageBaseReq.getPageSize());</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Pair&lt;T, Double&gt;&gt; result = typedTuples</span><br><span class="line">                .stream()</span><br><span class="line">                .map(t -&gt; Pair.of(typeConvert.apply(t.getValue()), t.getScore()))</span><br><span class="line">                .sorted((o1, o2) -&gt; o2.getValue().compareTo(o1.getValue()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="type">String</span> <span class="variable">cursor</span> <span class="operator">=</span> Optional.ofNullable(CollectionUtil.getLast(result))</span><br><span class="line">                .map(Pair::getValue)</span><br><span class="line">                .map(String::valueOf)</span><br><span class="line">                .orElse(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isLast</span> <span class="operator">=</span> result.size() != cursorPageBaseReq.getPageSize();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;&gt;(cursor, isLast, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; CursorPageBaseResp&lt;T&gt; <span class="title function_">getCursorPageByMysql</span><span class="params">(IService&lt;T&gt; mapper, CursorPageBaseReq request, Consumer&lt;LambdaQueryWrapper&lt;T&gt;&gt; initWrapper, SFunction&lt;T, ?&gt; cursorColumn)</span> &#123;</span><br><span class="line">        <span class="comment">//游标字段类型</span></span><br><span class="line">        Class&lt;?&gt; cursorType = LambdaUtils.getReturnType(cursorColumn);</span><br><span class="line">        LambdaQueryWrapper&lt;T&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//额外条件</span></span><br><span class="line">        initWrapper.accept(wrapper);</span><br><span class="line">        <span class="comment">//游标条件</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(request.getCursor())) &#123;</span><br><span class="line">            wrapper.lt(cursorColumn, parseCursor(request.getCursor(), cursorType));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//游标方向</span></span><br><span class="line">        wrapper.orderByDesc(cursorColumn);</span><br><span class="line"></span><br><span class="line">        Page&lt;T&gt; page = mapper.page(request.plusPage(), wrapper);</span><br><span class="line">        <span class="comment">//取出游标</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cursor</span> <span class="operator">=</span> Optional.ofNullable(CollectionUtil.getLast(page.getRecords()))</span><br><span class="line">                .map(cursorColumn)</span><br><span class="line">                .map(CursorUtils::toCursor)</span><br><span class="line">                .orElse(<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//判断是否最后一页</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isLast</span> <span class="operator">=</span> page.getRecords().size() != request.getPageSize();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CursorPageBaseResp</span>&lt;&gt;(cursor, isLast, page.getRecords());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">toCursor</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Date) &#123;</span><br><span class="line">            <span class="keyword">return</span> String.valueOf(((Date) o).getTime());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> o.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">parseCursor</span><span class="params">(String cursor, Class&lt;?&gt; cursorClass)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Date.class.isAssignableFrom(cursorClass)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(Long.parseLong(cursor));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> cursor;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LambdaUtils</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LambdaUtils</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字段映射</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Map&lt;String, ColumnCache&gt;&gt; COLUMN_CACHE_MAP = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SerializedLambda 反序列化缓存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, WeakReference&lt;com.baomidou.mybatisplus.core.toolkit.support.SerializedLambda&gt;&gt; FUNC_CACHE = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Pattern</span> <span class="variable">RETURN_TYPE_PATTERN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;\\(.*\\)L(.*);&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Pattern</span> <span class="variable">PARAMETER_TYPE_PATTERN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;\\((.*)\\).*&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> WeakConcurrentMap&lt;String, SerializedLambda&gt; cache = <span class="keyword">new</span> <span class="title class_">WeakConcurrentMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Lambda表达式返回类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getReturnType(Serializable serializable) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">expr</span> <span class="operator">=</span> _resolve(serializable).getInstantiatedMethodType();</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> RETURN_TYPE_PATTERN.matcher(expr);</span><br><span class="line">        <span class="keyword">if</span> (!matcher.find() || matcher.groupCount() != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;获取Lambda信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> matcher.group(<span class="number">1</span>).replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Class.forName(className);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;无法加载类&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Class&lt;?&gt; getReturnType(SFunction&lt;T, ?&gt; func) &#123;</span><br><span class="line">        com.baomidou.mybatisplus.core.toolkit.support.<span class="type">SerializedLambda</span> <span class="variable">lambda</span> <span class="operator">=</span> com.baomidou.mybatisplus.core.toolkit.LambdaUtils.resolve(func);</span><br><span class="line">        Class&lt;?&gt; aClass = lambda.getInstantiatedType();</span><br><span class="line">        <span class="type">String</span> <span class="variable">fieldName</span> <span class="operator">=</span> PropertyNamer.methodToProperty(lambda.getImplMethodName());</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> aClass.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.getType();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Lambda表达式的参数类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Class&lt;?&gt;&gt; getParameterTypes(Serializable serializable) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">expr</span> <span class="operator">=</span> _resolve(serializable).getInstantiatedMethodType();</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> PARAMETER_TYPE_PATTERN.matcher(expr);</span><br><span class="line">        <span class="keyword">if</span> (!matcher.find() || matcher.groupCount() != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;获取Lambda信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        expr = matcher.group(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(expr.split(<span class="string">&quot;;&quot;</span>))</span><br><span class="line">                .filter(StrUtil::isNotBlank)</span><br><span class="line">                .map(s -&gt; s.replace(<span class="string">&quot;L&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;.&quot;</span>))</span><br><span class="line">                .map(s -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> Class.forName(s);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;无法加载类&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析lambda表达式,加了缓存。</span></span><br><span class="line"><span class="comment">     * 该缓存可能会在任意不定的时间被清除。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 通过反射调用实现序列化接口函数对象的writeReplace方法，从而拿到&#123;<span class="doctag">@link</span> SerializedLambda&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 该对象中包含了lambda表达式的所有信息。</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> func 需要解析的 lambda 对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回解析后的结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SerializedLambda <span class="title function_">_resolve</span><span class="params">(Serializable func)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cache.computeIfAbsent(func.getClass().getName(), (key)</span><br><span class="line">                -&gt; ReflectUtil.invoke(func, <span class="string">&quot;writeReplace&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="封装Starter"><a href="#封装Starter" class="headerlink" title="封装Starter"></a>封装Starter</h2><p>虽然在前面的SpringBoot篇章我们也封装了一次，但是现在是实战</p>
<p>此时我们需要封装一个OSS的starter，支持自定义切换（简略，仅提供思路）</p>
<p>众所周知，封装一个Starter我们需要提供一个AutoConfiguration给SpringBoot</p>
<p>那么肯定需要创建<code>resource/META-INF/spirng.factories</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Auto Configure</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">com.calyee.chat.oss.MinIOConfiguration</span></span><br></pre></td></tr></table></figure>

<p>这样boot就会扫描到这个自动配置类，然后加载配置</p>
<p><code>MinIOConfiguration</code>自动配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(OssProperties.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnExpression(&quot;$&#123;oss.enabled&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(value = &quot;oss.type&quot;, havingValue = &quot;minio&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinIOConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(MinioClient.class)</span></span><br><span class="line">    <span class="keyword">public</span> MinioClient <span class="title function_">minioClient</span><span class="params">(OssProperties ossProperties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MinioClient.builder()</span><br><span class="line">                .endpoint(ossProperties.getEndpoint())</span><br><span class="line">                .credentials(ossProperties.getAccessKey(), ossProperties.getSecretKey())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnBean(&#123;MinioClient.class&#125;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(MinIOTemplate.class)</span></span><br><span class="line">    <span class="keyword">public</span> MinIOTemplate <span class="title function_">minioTemplate</span><span class="params">(MinioClient minioClient, OssProperties ossProperties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MinIOTemplate</span>(minioClient, ossProperties);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>OssProperties</code>读取yml配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;oss&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OssProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否开启</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Boolean enabled;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存储对象服务器类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    OssType type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * OSS 访问端点，集群时需提供统一入口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String endpoint;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String accessKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String secretKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存储桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String bucketName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仅仅列出上述两点，对于其他的文件大同小异，仅有当前两项是重点，一个是自动配置类，一个是读取配置文件，其中还有一些注解需要理解（一些可以参见SpringBoot章节）</p>
<h2 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h2><h3 id="AQS-类定义以及-Node-节点数据结构说明"><a href="#AQS-类定义以及-Node-节点数据结构说明" class="headerlink" title="AQS 类定义以及 Node 节点数据结构说明"></a>AQS 类定义以及 Node 节点数据结构说明</h3><p>众所周知 AQS 是AbstractQueuedSynchronizer 的简称</p>
<p>然后他有两个重要的属性</p>
<ol>
<li>state:   volatile int state</li>
</ol>
<p>它代表着一个同步状态，他在不同的实现子类中有不同的实现</p>
<p>例如在ReentrantLock 中 state &#x3D; 1 代表当前共享资源已经被加锁，&gt; 1 则代表被多次加锁</p>
<p>然后对于 state 的操作，他有三个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getState</span><span class="params">()</span>;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setState</span><span class="params">()</span>;</span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSetState</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p>其实compareAndSetState()我们可以看做 CAS</p>
<p>CAS： 全称是<strong>C</strong>ompare<strong>A</strong>nd<strong>S</strong>wap，是一种用于在多线程环境下实现同步功能的机制。CAS操作包含三个操作数：<strong>内存位置</strong>、<strong>预期数值</strong>和<strong>新值</strong>.</p>
<p>CAS的实现逻辑是将内存位置处的数值与预期数值想比较，若相等，则将内存位置处的值替换为新值。若不相等，则不做任何操作。</p>
<ol>
<li>Node 节点</li>
</ol>
<p>其中 Node 节点结构如下：（双向链表 同步队列）</p>
<table>
<thead>
<tr>
<th>int</th>
<th>waitStatus</th>
</tr>
</thead>
<tbody><tr>
<td>Node</td>
<td>prev</td>
</tr>
<tr>
<td>Node</td>
<td>next</td>
</tr>
<tr>
<td>Thread</td>
<td>thread</td>
</tr>
</tbody></table>
<p>对于 Node 节点，做如下解释：当一个线程拿不到锁的时候，他就会被添加到 Node 节点的双向链表中</p>
<p>​          +——+  prev  +—–+         +—–+</p>
<p>  head |          |  &lt;—-  |          | &lt;—- |         |  tail</p>
<p>​          +——+           +—–+          +—–+</p>
<p>其中 Head 与 Tail 指针是用于标记阻塞线程节点的头尾指针，中间的节点其实就是 Node 节点，可以理解为队列，一个一个的取，处理完成则去除当前线程节点，然后指向下一个节点。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://calyee-image.pages.dev/file/95af5e03573696fce6be7.png" referrerpolicy="no-referrer" alt="AQS同步队列"></p>
<p>如果 thread-0 执行完毕后，他对应的 state &#x3D; 0，然后释放锁，此时 AQS 队列中排队等待的线程则会按连接顺序依次出队列。此时 thread-1 不是说 thread-1 释放锁了他就直接拿到锁，他还是像之前没有拿到锁一样，通过 cas 进行修改 state 值然后拿锁。假设 thread-1 成功持有锁了，那么 aqs 维护的队列就会让队头元素出队，然后刚刚获取锁的线程成为头结点。然后一直重复入队出队的操作。</p>
<p>：持有锁修改 state 为 1，释放锁修改 state 为 0</p>
<h3 id="从ReentrantLock的非公平独占锁实现来看AQS的原理"><a href="#从ReentrantLock的非公平独占锁实现来看AQS的原理" class="headerlink" title="从ReentrantLock的非公平独占锁实现来看AQS的原理"></a>从ReentrantLock的非公平独占锁实现来看AQS的原理</h3><p>通过了解类 AbstractQueuedSynchronizer 我们可以知道他是一个抽象类，其中他还有一个父类AbstractOwnableSynchronizer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractOwnableSynchronizer</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">3737899427754241961L</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">AbstractOwnableSynchronizer</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 目前持有独占锁的线程</span></span><br><span class="line"><span class="comment">     * The current owner of exclusive mode synchronization.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Thread exclusiveOwnerThread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此项用于设置上述属性的值</span></span><br><span class="line"><span class="comment">     * Sets the thread that currently owns exclusive access.</span></span><br><span class="line"><span class="comment">     * A &#123;<span class="doctag">@code</span> null&#125; argument indicates that no thread owns access.</span></span><br><span class="line"><span class="comment">     * This method does not otherwise impose any synchronization or</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> volatile&#125; field accesses.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> thread the owner thread</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setExclusiveOwnerThread</span><span class="params">(Thread thread)</span> &#123;</span><br><span class="line">        exclusiveOwnerThread = thread; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此项用于获取上述属性的值</span></span><br><span class="line"><span class="comment">     * Returns the thread last set by &#123;<span class="doctag">@code</span> setExclusiveOwnerThread&#125;,</span></span><br><span class="line"><span class="comment">     * or &#123;<span class="doctag">@code</span> null&#125; if never set.  This method does not otherwise</span></span><br><span class="line"><span class="comment">     * impose any synchronization or &#123;<span class="doctag">@code</span> volatile&#125; field accesses.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the owner thread</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Thread <span class="title function_">getExclusiveOwnerThread</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> exclusiveOwnerThread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 AQS 中比较重要的成员变量有：1. head：头指针    2. tail：尾指针</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractQueuedSynchronizer</span></span><br><span class="line">    <span class="keyword">extends</span> <span class="title class_">AbstractOwnableSynchronizer</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7373984972572414691L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">AbstractQueuedSynchronizer</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Head of the wait queue, lazily initialized.  Except for</span></span><br><span class="line"><span class="comment">     * initialization, it is modified only via method setHead.  Note:</span></span><br><span class="line"><span class="comment">     * If head exists, its waitStatus is guaranteed not to be</span></span><br><span class="line"><span class="comment">     * CANCELLED.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node head;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tail of the wait queue, lazily initialized.  Modified only via</span></span><br><span class="line"><span class="comment">     * method enq to add new wait node.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The synchronization state.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the current value of synchronization state.</span></span><br><span class="line"><span class="comment">     * This operation has memory semantics of a &#123;<span class="doctag">@code</span> volatile&#125; read.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> current state value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getState</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the value of synchronization state.</span></span><br><span class="line"><span class="comment">     * This operation has memory semantics of a &#123;<span class="doctag">@code</span> volatile&#125; write.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newState the new state value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setState</span><span class="params">(<span class="type">int</span> newState)</span> &#123;</span><br><span class="line">        state = newState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically sets synchronization state to the given updated</span></span><br><span class="line"><span class="comment">     * value if the current state value equals the expected value.</span></span><br><span class="line"><span class="comment">     * This operation has memory semantics of a &#123;<span class="doctag">@code</span> volatile&#125; read</span></span><br><span class="line"><span class="comment">     * and write.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> expect the expected value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> update the new value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if successful. False return indicates that the actual</span></span><br><span class="line"><span class="comment">     *         value was not equal to the expected value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSetState</span><span class="params">(<span class="type">int</span> expect, <span class="type">int</span> update)</span> &#123;</span><br><span class="line">        <span class="comment">// See below for intrinsics setup to support this</span></span><br><span class="line">        <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="built_in">this</span>, stateOffset, expect, update);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Queuing utilities</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The number of nanoseconds for which it is faster to spin</span></span><br><span class="line"><span class="comment">     * rather than to use timed park. A rough estimate suffices</span></span><br><span class="line"><span class="comment">     * to improve responsiveness with very short timeouts.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">spinForTimeoutThreshold</span> <span class="operator">=</span> <span class="number">1000L</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>state：在前一节已经解释过</p>
<p>spinForTimeoutThreshold：超时中断</p>
<p>其中AQS 中还有一个 Node 静态内部类代码块</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    <span class="comment">/** 共享 -- 共享锁 */</span></span><br><span class="line">    <span class="comment">/** Marker to indicate a node is waiting in shared mode */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">SHARED</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">    <span class="comment">/** 排他 -- 独占锁 */</span>     </span><br><span class="line">    <span class="comment">/** Marker to indicate a node is waiting in exclusive mode */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">EXCLUSIVE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">/** 初始化 */</span></span><br><span class="line">    <span class="comment">/** waitStatus value to indicate thread has cancelled */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span> <span class="operator">=</span>  <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/** 下一个节点需要被唤醒 */</span></span><br><span class="line">    <span class="comment">/** waitStatus value to indicate successor&#x27;s thread needs unparking */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNAL</span>    <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/** 下一个节点需要被唤醒 */</span></span><br><span class="line">    <span class="comment">/** waitStatus value to indicate thread is waiting on condition */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONDITION</span> <span class="operator">=</span> -<span class="number">2</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * waitStatus value to indicate the next acquireShared should</span></span><br><span class="line"><span class="comment">     * unconditionally propagate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PROPAGATE</span> <span class="operator">=</span> -<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> waitStatus; <span class="comment">// 初始化为0，枚举值使用上面的值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 前驱节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 后继节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The thread that enqueued this node.  Initialized on</span></span><br><span class="line"><span class="comment">     * construction and nulled out after use.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在条件队列指向的是下一个指针</span></span><br><span class="line"><span class="comment">     * 在同步队列中指向的是我们当前节点想获取的是共享锁还是排他锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node nextWaiter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns true if node is waiting in shared mode.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isShared</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nextWaiter == SHARED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns previous node, or throws NullPointerException if null.</span></span><br><span class="line"><span class="comment">     * Use when predecessor cannot be null.  The null check could</span></span><br><span class="line"><span class="comment">     * be elided, but is present to help the VM.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the predecessor of this node</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> Node <span class="title function_">predecessor</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> prev;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node() &#123;    <span class="comment">// Used to establish initial head or SHARED marker</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, Node mode) &#123;     <span class="comment">// Used by addWaiter</span></span><br><span class="line">        <span class="built_in">this</span>.nextWaiter = mode;</span><br><span class="line">        <span class="built_in">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Node(Thread thread, <span class="type">int</span> waitStatus) &#123; <span class="comment">// Used by Condition</span></span><br><span class="line">        <span class="built_in">this</span>.waitStatus = waitStatus;</span><br><span class="line">        <span class="built_in">this</span>.thread = thread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="抽象类的使用-最佳实践"><a href="#抽象类的使用-最佳实践" class="headerlink" title="抽象类的使用(最佳实践)"></a>抽象类的使用(最佳实践)</h2><p>当前抽象类为：Redis批量缓存</p>
<p>先抽象接口</p>
<p><code>BatchCache interface</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BatchCache</span>&lt;IN, OUT&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取单个</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    OUT <span class="title function_">get</span><span class="params">(IN req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取批量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Map&lt;IN, OUT&gt; <span class="title function_">getBatch</span><span class="params">(List&lt;IN&gt; req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改删除单个</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(IN req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改删除多个</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteBatch</span><span class="params">(List&lt;IN&gt; req)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在抽象类，抽象的原方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户信息，盘路缓存模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;Long, User&gt; <span class="title function_">getUserInfoBatch</span><span class="params">(Set&lt;Long&gt; uids)</span> &#123;</span><br><span class="line">    <span class="comment">//批量组装key</span></span><br><span class="line">    List&lt;String&gt; keys = uids.stream().map(a -&gt; RedisKey.getKey(RedisKey.USER_INFO_STRING, a)).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//批量get</span></span><br><span class="line">    List&lt;User&gt; mget = RedisUtils.mget(keys, User.class);</span><br><span class="line">    Map&lt;Long, User&gt; map = mget.stream().filter(Objects::nonNull).collect(Collectors.toMap(User::getId, Function.identity()));</span><br><span class="line">    <span class="comment">//发现差集——还需要load更新的uid</span></span><br><span class="line">    List&lt;Long&gt; needLoadUidList = uids.stream().filter(a -&gt; !map.containsKey(a)).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">if</span> (CollUtil.isNotEmpty(needLoadUidList)) &#123;</span><br><span class="line">        <span class="comment">//批量load</span></span><br><span class="line">        List&lt;User&gt; needLoadUserList = userDao.listByIds(needLoadUidList);</span><br><span class="line">        Map&lt;String, User&gt; redisMap = needLoadUserList.stream().collect(Collectors.toMap(a -&gt; RedisKey.getKey(RedisKey.USER_INFO_STRING, a.getId()), Function.identity()));</span><br><span class="line">        RedisUtils.mset(redisMap, <span class="number">5</span> * <span class="number">60</span>);</span><br><span class="line">        <span class="comment">//加载回redis</span></span><br><span class="line">        map.putAll(needLoadUserList.stream().collect(Collectors.toMap(User::getId, Function.identity())));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>抽象后的方法，因为后面都需要复用这样的方法，所以抽取公共的</p>
<p><code>AbstractRedisStringCache</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollectionUtil;</span><br><span class="line"><span class="keyword">import</span> com.calyee.chat.common.common.utils.RedisUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.util.Pair;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.ParameterizedType;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: redis string类型的批量缓存框架</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractRedisStringCache</span>&lt;IN, OUT&gt; <span class="keyword">implements</span> <span class="title class_">BatchCache</span>&lt;IN, OUT&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;OUT&gt; outClass;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">AbstractRedisStringCache</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ParameterizedType</span> <span class="variable">genericSuperclass</span> <span class="operator">=</span> (ParameterizedType) <span class="built_in">this</span>.getClass().getGenericSuperclass();</span><br><span class="line">        <span class="built_in">this</span>.outClass = (Class&lt;OUT&gt;) genericSuperclass.getActualTypeArguments()[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title function_">getKey</span><span class="params">(IN req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> Long <span class="title function_">getExpireSeconds</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> Map&lt;IN, OUT&gt; <span class="title function_">load</span><span class="params">(List&lt;IN&gt; req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> OUT <span class="title function_">get</span><span class="params">(IN req)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getBatch(Collections.singletonList(req)).get(req);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;IN, OUT&gt; <span class="title function_">getBatch</span><span class="params">(List&lt;IN&gt; req)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtil.isEmpty(req)) &#123;<span class="comment">//防御性编程</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//去重</span></span><br><span class="line">        req = req.stream().distinct().collect(Collectors.toList());</span><br><span class="line">        <span class="comment">//组装key</span></span><br><span class="line">        List&lt;String&gt; keys = req.stream().map(<span class="built_in">this</span>::getKey).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">//批量get</span></span><br><span class="line">        List&lt;OUT&gt; valueList = RedisUtils.mget(keys, outClass);</span><br><span class="line">        <span class="comment">//差集计算</span></span><br><span class="line">        List&lt;IN&gt; loadReqs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; valueList.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Objects.isNull(valueList.get(i))) &#123;</span><br><span class="line">                loadReqs.add(req.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;IN, OUT&gt; load = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//不足的重新加载进redis</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtil.isNotEmpty(loadReqs)) &#123;</span><br><span class="line">            <span class="comment">//批量load</span></span><br><span class="line">            load = load(loadReqs);</span><br><span class="line">            Map&lt;String, OUT&gt; loadMap = load.entrySet().stream()</span><br><span class="line">                    .map(a -&gt; Pair.of(getKey(a.getKey()), a.getValue()))</span><br><span class="line">                    .collect(Collectors.toMap(Pair::getFirst, Pair::getSecond));</span><br><span class="line">            RedisUtils.mset(loadMap, getExpireSeconds());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//组装最后的结果</span></span><br><span class="line">        Map&lt;IN, OUT&gt; resultMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; req.size(); i++) &#123;</span><br><span class="line">            <span class="type">IN</span> <span class="variable">in</span> <span class="operator">=</span> req.get(i);</span><br><span class="line">            <span class="type">OUT</span> <span class="variable">out</span> <span class="operator">=</span> Optional.ofNullable(valueList.get(i))</span><br><span class="line">                    .orElse(load.get(in));</span><br><span class="line">            resultMap.put(in, out);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(IN req)</span> &#123;</span><br><span class="line">        deleteBatch(Collections.singletonList(req));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteBatch</span><span class="params">(List&lt;IN&gt; req)</span> &#123;</span><br><span class="line">        List&lt;String&gt; keys = req.stream().map(<span class="built_in">this</span>::getKey).collect(Collectors.toList());</span><br><span class="line">        RedisUtils.del(keys);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 RedisUtils见[开发小手册 | Calyee&#96;Blog](<a href="https://blog.calyee.top/2023/11/04/%E5%BC%80%E5%8F%91%E5%B0%8F%E6%89%8B%E5%86%8C/">https://blog.calyee.top/2023/11/04/开发小手册/</a>)</p>
<p>样例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfoCache</span> <span class="keyword">extends</span> <span class="title class_">AbstractRedisStringCache</span>&lt;Long, User&gt; &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getKey</span><span class="params">(Long uid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RedisKey.getKey(RedisKey.USER_INFO_STRING, uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Long <span class="title function_">getExpireSeconds</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">5</span> * <span class="number">60L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;Long, User&gt; <span class="title function_">load</span><span class="params">(List&lt;Long&gt; uidList)</span> &#123;</span><br><span class="line">        List&lt;User&gt; needLoadUserList = userDao.listByIds(uidList);</span><br><span class="line">        <span class="keyword">return</span> needLoadUserList.stream().collect(Collectors.toMap(User::getId, Function.identity()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="请求上下文RequestHolder"><a href="#请求上下文RequestHolder" class="headerlink" title="请求上下文RequestHolder"></a>请求上下文RequestHolder</h2><p>对于登录的用户，我们会将uid设置为请求属性，在CollectorInterceptor中统一收集。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CollectorInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span>, WebMvcConfigurer &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="built_in">this</span>)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">RequestInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestInfo</span>();</span><br><span class="line">        info.setUid(Optional.ofNullable(request.getAttribute(TokenInterceptor.ATTRIBUTE_UID)).map(Object::toString).map(Long::parseLong).orElse(<span class="literal">null</span>));</span><br><span class="line">        info.setIp(ServletUtil.getClientIP(request));</span><br><span class="line">        RequestHolder.set(info);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        RequestHolder.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="聊天项目中的工厂模式和策略模式组合"><a href="#聊天项目中的工厂模式和策略模式组合" class="headerlink" title="聊天项目中的工厂模式和策略模式组合"></a>聊天项目中的工厂模式和策略模式组合</h2><p>例如我们现在有一个需求，对于传入的不同数据进行不同的处理（比如QQ发消息，他聊天框可以发送不同类型的消息，这个是不是就可以用策略模式+工厂模式进行推送处理，即我需要对不同的数据进行不同的处理）</p>
<p>那么就可以使用这个组合：</p>
<p>我们先定义一个抽象类模板：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description: 消息处理器抽象类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractMsgHandler</span>&lt;Req&gt; &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageDao messageDao;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;Req&gt; bodyClass;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ParameterizedType</span> <span class="variable">genericSuperclass</span> <span class="operator">=</span> (ParameterizedType) <span class="built_in">this</span>.getClass().getGenericSuperclass();</span><br><span class="line">        <span class="built_in">this</span>.bodyClass = (Class&lt;Req&gt;) genericSuperclass.getActualTypeArguments()[<span class="number">0</span>];</span><br><span class="line">        MsgHandlerFactory.register(getMsgTypeEnum().getType(), <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">abstract</span> MessageTypeEnum <span class="title function_">getMsgTypeEnum</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">checkMsg</span><span class="params">(Req body, Long roomId, Long uid)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">checkAndSaveMsg</span><span class="params">(ChatMessageReq request, Long uid)</span> &#123;</span><br><span class="line">        <span class="type">Req</span> <span class="variable">body</span> <span class="operator">=</span> <span class="built_in">this</span>.toBean(request.getBody());</span><br><span class="line">        <span class="comment">//统一校验</span></span><br><span class="line">        AssertUtil.allCheckValidateThrow(body);</span><br><span class="line">        <span class="comment">//子类扩展校验</span></span><br><span class="line">        checkMsg(body, request.getRoomId(), uid);</span><br><span class="line">        <span class="type">Message</span> <span class="variable">insert</span> <span class="operator">=</span> MessageAdapter.buildMsgSave(request, uid);</span><br><span class="line">        <span class="comment">//统一保存</span></span><br><span class="line">        messageDao.save(insert);</span><br><span class="line">        <span class="comment">//子类扩展保存</span></span><br><span class="line">        saveMsg(insert, body);</span><br><span class="line">        <span class="keyword">return</span> insert.getId();</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// </span></span><br><span class="line">    <span class="keyword">private</span> Req <span class="title function_">toBean</span><span class="params">(Object body)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (bodyClass.isAssignableFrom(body.getClass())) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Req) body;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> BeanUtil.toBean(body, bodyClass);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 需要保存的逻辑</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">saveMsg</span><span class="params">(Message message, Req body)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 展示消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title function_">showMsg</span><span class="params">(Message msg)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 被回复时——展示的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title function_">showReplyMsg</span><span class="params">(Message msg)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 会话列表——展示的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title function_">showContactMsg</span><span class="params">(Message msg)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提供一个实现类样例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmojisMsgHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstractMsgHandler</span>&lt;EmojisMsgDTO&gt; &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageDao messageDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    MessageTypeEnum <span class="title function_">getMsgTypeEnum</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> MessageTypeEnum.EMOJI;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveMsg</span><span class="params">(Message msg, EmojisMsgDTO body)</span> &#123;</span><br><span class="line">        <span class="type">MessageExtra</span> <span class="variable">extra</span> <span class="operator">=</span> Optional.ofNullable(msg.getExtra()).orElse(<span class="keyword">new</span> <span class="title class_">MessageExtra</span>());</span><br><span class="line">        <span class="type">Message</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">        update.setId(msg.getId());</span><br><span class="line">        update.setExtra(extra);</span><br><span class="line">        extra.setEmojisMsgDTO(body);</span><br><span class="line">        messageDao.updateById(update);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">showMsg</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> msg.getExtra().getEmojisMsgDTO();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">showReplyMsg</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;表情&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">showContactMsg</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[表情包]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们需要提供一个工厂创建场景对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MsgHandlerFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Integer, AbstractMsgHandler&gt; STRATEGY_MAP = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Integer code, AbstractMsgHandler strategy)</span> &#123;</span><br><span class="line">        STRATEGY_MAP.put(code, strategy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AbstractMsgHandler <span class="title function_">getStrategyNoNull</span><span class="params">(Integer code)</span> &#123;</span><br><span class="line">        <span class="type">AbstractMsgHandler</span> <span class="variable">strategy</span> <span class="operator">=</span> STRATEGY_MAP.get(code);</span><br><span class="line">        AssertUtil.isNotEmpty(strategy, CommonErrorEnum.PARAM_INVALID);</span><br><span class="line">        <span class="keyword">return</span> strategy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 发送消息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">sendMsg</span><span class="params">(ChatMessageReq request, Long uid)</span> &#123;</span><br><span class="line">    check(request, uid);</span><br><span class="line">    AbstractMsgHandler&lt;?&gt; msgHandler = MsgHandlerFactory.getStrategyNoNull(request.getMsgType()); <span class="comment">// 这里</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">msgId</span> <span class="operator">=</span> msgHandler.checkAndSaveMsg(request, uid);</span><br><span class="line">    <span class="comment">//发布消息发送事件</span></span><br><span class="line">    applicationEventPublisher.publishEvent(<span class="keyword">new</span> <span class="title class_">MessageSendEvent</span>(<span class="built_in">this</span>, msgId));</span><br><span class="line">    <span class="keyword">return</span> msgId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际开发也能用到（笔者在实习的时候就用上了！）</p>
<p>一步一步改造</p>
<p>场景：我 需要对不同数据进行不同的处理，什么个不同法，比如这个数据需要求和 另外一个需要求平均 还有需要求时间最早的等等等场景</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CountModeType: 求和/平均 ...</span><br><span class="line">Data: List&lt;?&gt;/String[] ...</span><br></pre></td></tr></table></figure>

<h2 id="实际开发中的工厂加策略模式"><a href="#实际开发中的工厂加策略模式" class="headerlink" title="实际开发中的工厂加策略模式"></a>实际开发中的工厂加策略模式</h2><p>笔者扩展的</p>
<h3 id="工厂模式-1-策略抽象一层"><a href="#工厂模式-1-策略抽象一层" class="headerlink" title="工厂模式 1(策略抽象一层)"></a>工厂模式 1(策略抽象一层)</h3><p><strong>对于固定的模版（比如处理 excel 的数据，他是固定的）</strong></p>
<p>（下面图例为工厂 1 的模式）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/38974401/1720688832343-2e61784f-4669-44dd-95f0-491fc9dc5afc.png" referrerpolicy="no-referrer" alt="img"></p>
<p>那么我们可以定义一个模版</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> AbstractDataHandler</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 数据处理抽象类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> Calyee</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractDataHandler</span>  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        DataHandlerFactory.register(getCountModeEnums(), <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取模式类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> CountModeEnums</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> CountModeEnums <span class="title function_">getCountModeEnums</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title function_">processData</span><span class="params">(List&lt;?&gt; o)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>策略（例如我们在此是求和策略，当然也可以求平均）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SumHandler</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 求和处理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> Calyee</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OperationSumBaseDataHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstractDataHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CountModeEnums <span class="title function_">getCountModeEnums</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CountModeEnums.sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">processData</span><span class="params">(List&lt;?&gt; o)</span> &#123;</span><br><span class="line">        Assert.notNull(o, <span class="string">&quot;当前处理的数据不能为空&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">type</span> <span class="operator">=</span> o.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">switch</span> (type.getClass().getSimpleName()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Integer&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> o.stream()</span><br><span class="line">                        .mapToInt(Integer.class::cast)</span><br><span class="line">                        .sum();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Long&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> o.stream()</span><br><span class="line">                        .mapToLong(Long.class::cast)</span><br><span class="line">                        .sum();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Double&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> o.stream()</span><br><span class="line">                        .mapToDouble(Double.class::cast)</span><br><span class="line">                        .sum();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Float&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> o.stream()</span><br><span class="line">                        .mapToDouble(Float.class::cast)</span><br><span class="line">                        .sum();</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;该类型暂不支持&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>工厂类型 1：我们需要提供方法给他进行调用计算</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataHandlerFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;CountModeEnums, AbstractDataHandler&gt; STRATEGY_MAP = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(CountModeEnums enums, AbstractDataHandler strategy)</span> &#123;</span><br><span class="line">        STRATEGY_MAP.put(enums, strategy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AbstractDataHandler <span class="title function_">getStrategyNoNullByObj</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="type">CountModeEnums</span> <span class="variable">countModeEnums</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Example) &#123;</span><br><span class="line">            <span class="type">Example</span> <span class="variable">p</span> <span class="operator">=</span> (Example) o;</span><br><span class="line">            countModeEnums = p.getCountModeEnums();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>()&#123;</span><br><span class="line">            <span class="comment">// 其他的枚举</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> haveSuitableStrategy(countModeEnums); <span class="comment">// 拿到具体的策略</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AbstractDataHandler <span class="title function_">haveSuitableStrategy</span><span class="params">(CountModeEnums enums)</span> &#123;</span><br><span class="line">        <span class="type">AbstractDataHandler</span> <span class="variable">handler</span> <span class="operator">=</span> STRATEGY_MAP.get(enums);</span><br><span class="line">        Assert.notNull(handler, <span class="string">&quot;没有对应的处理策略&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用的表现形式体现为：我们需要手动调用，这种方式常常用于策略模式很多的情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Example</span> <span class="variable">avg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Example</span>();</span><br><span class="line">avg.setCountModeEnums(CountModeEnums.avg);</span><br><span class="line">avg.setData(Arrays.asList(<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>, <span class="number">5.0</span>));</span><br><span class="line"><span class="type">AbstractHandler</span> <span class="variable">avgHandler</span> <span class="operator">=</span> DataHandlerFactory.getStrategyNoNullByObj(avg);</span><br><span class="line"><span class="comment">// ========这一步我们需要手动调用========= </span></span><br><span class="line"><span class="type">Object</span> <span class="variable">oavg</span> <span class="operator">=</span> avgHandler.processData(sum.getData());</span><br><span class="line"><span class="comment">// ===================================== </span></span><br><span class="line">log.info(<span class="string">&quot;avg: &#123;&#125;, exp: &#123;&#125;, equals: &#123;&#125;&quot;</span>, oavg, <span class="number">3.0</span>, oavg.equals(<span class="number">3.0</span>)); <span class="comment">// 3.0 3.0 true</span></span><br></pre></td></tr></table></figure>

<p>工厂模式一总结：对于策略固定且策略较多的情况 ，我们可以使用此类型，即我们模版可以使用同一个，然后具体实现具体分析，通过给对象然后从工厂生产出具体的策略，然后自己调用</p>
<h3 id="工厂模式-2-策略抽象两层-可拓展性更强"><a href="#工厂模式-2-策略抽象两层-可拓展性更强" class="headerlink" title="工厂模式 2(策略抽象两层 可拓展性更强)"></a>工厂模式 2(策略抽象两层 可拓展性更强)</h3><p>当前模式适用于更复杂的场景，例如：</p>
<p>（工厂 2 模式  出场）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/38974401/1720689229810-5ef8e535-e67b-4c66-a8cb-3666c921d6b2.png" referrerpolicy="no-referrer" alt="img"></p>
<p>对于当前的策略：</p>
<p>定义基础抽象父类模版</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> AbstractHandler</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 上层基础模版</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> Calyee</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractHandler</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>分区抽象模版</strong></p>
<p>基础数据处理抽象类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> AbstractDataHandler</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 基础数据处理抽象模版方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> Calyee</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractDataBaseOperationHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstractHandler</span> &#123;</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        DataHandlerFactory.register(getCountModeEnums(), <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取模式类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> CountModeEnums</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> CountModeEnums <span class="title function_">getCountModeEnums</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> o</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title function_">processData</span><span class="params">(List&lt;?&gt; o)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> AbstractDataTimeOperationHandler</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 对于时间的运算抽象模版方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> Calyee</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractDataTimeOperationHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstractHandler</span> &#123;</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        DataHandlerFactory.register(getCountModeEnums(), <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取模式类型</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> CountModeEnums</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> com.bdsoft.peration.enums.CountModeEnums</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> CountModeEnums <span class="title function_">getCountModeEnums</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理年份数据</span></span><br><span class="line"><span class="comment">     * 说明：时间与数据应该一一对应(例如)</span></span><br><span class="line"><span class="comment">     * data1: 2023-03-01 2023-03-02 2023-03-04 2023-03-06  ...</span></span><br><span class="line"><span class="comment">     * data2: 100        300        20         40          ...</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data1 时间对应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data2 数据对应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ans</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title function_">processData</span><span class="params">(List&lt;Date&gt; data1, List&lt;?&gt; data2)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>策略具体实现（仅给出一个案例）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span> SumHandler</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 求和处理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> Calyee</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OperationSumBaseDataHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstractDataBaseOperationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CountModeEnums <span class="title function_">getCountModeEnums</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CountModeEnums.sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">processData</span><span class="params">(List&lt;?&gt; o)</span> &#123;</span><br><span class="line">        Assert.notNull(o, <span class="string">&quot;当前处理的数据不能为空&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">type</span> <span class="operator">=</span> o.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">switch</span> (type.getClass().getSimpleName()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Integer&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> o.stream()</span><br><span class="line">                        .mapToInt(Integer.class::cast)</span><br><span class="line">                        .sum();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Long&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> o.stream()</span><br><span class="line">                        .mapToLong(Long.class::cast)</span><br><span class="line">                        .sum();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Double&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> o.stream()</span><br><span class="line">                        .mapToDouble(Double.class::cast)</span><br><span class="line">                        .sum();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;Float&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> o.stream()</span><br><span class="line">                        .mapToDouble(Float.class::cast)</span><br><span class="line">                        .sum();</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;该类型暂不支持&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>工厂方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataHandlerFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;CountModeEnums, AbstractHandler&gt; STRATEGY_MAP = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(CountModeEnums enums, AbstractHandler strategy)</span> &#123;</span><br><span class="line">        STRATEGY_MAP.put(enums, strategy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getStrategyNoNullByObj</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> ExampleBaseDataCalculate) &#123; <span class="comment">// 简单基础数据运算</span></span><br><span class="line">            <span class="type">ExampleBaseDataCalculate</span> <span class="variable">p</span> <span class="operator">=</span> (ExampleBaseDataCalculate) o;</span><br><span class="line">            <span class="type">AbstractDataBaseOperationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (AbstractDataBaseOperationHandler) haveSuitableStrategy(p.getCountModeEnums());</span><br><span class="line">            <span class="keyword">return</span> handler.processData(p.getData());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o <span class="keyword">instanceof</span> ExampleYearCalculate) &#123;<span class="comment">// 年份数据运算</span></span><br><span class="line">            <span class="type">ExampleYearCalculate</span> <span class="variable">p</span> <span class="operator">=</span> (ExampleYearCalculate) o;</span><br><span class="line">            <span class="type">AbstractDataTimeOperationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (AbstractDataTimeOperationHandler) haveSuitableStrategy(p.getEnums());</span><br><span class="line">            <span class="keyword">return</span> handler.processData(p.getData1(), p.getData2());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;暂时没有该处理&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AbstractHandler <span class="title function_">haveSuitableStrategy</span><span class="params">(CountModeEnums enums)</span> &#123;</span><br><span class="line">        <span class="type">AbstractHandler</span> <span class="variable">handler</span> <span class="operator">=</span> STRATEGY_MAP.get(enums);</span><br><span class="line">        Assert.notNull(handler, <span class="string">&quot;没有对应的处理策略&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试用例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExampleBaseDataCalculate</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExampleBaseDataCalculate</span>();</span><br><span class="line"><span class="comment">// 模拟查询到的数据</span></span><br><span class="line">sum.setCountModeEnums(CountModeEnums.sum);</span><br><span class="line">sum.setData(Arrays.asList(<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>, <span class="number">5.0</span>));</span><br><span class="line"><span class="comment">// 数据处理</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">ans</span> <span class="operator">=</span> DataHandlerFactory.getStrategyNoNullByObj(sum);</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;sum: &#123;&#125;, exp:&#123;&#125;, equals: &#123;&#125;&quot;</span>, ans, <span class="number">15.0</span>, ans.equals(<span class="number">15.0</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">ExampleBaseDataCalculate</span> <span class="variable">avg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExampleBaseDataCalculate</span>();</span><br><span class="line"><span class="comment">// 模拟查询到的数据</span></span><br><span class="line">avg.setCountModeEnums(CountModeEnums.avg);</span><br><span class="line">avg.setData(Arrays.asList(<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>, <span class="number">5.0</span>));</span><br><span class="line"><span class="comment">// 数据处理</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">avgAns</span> <span class="operator">=</span> DataHandlerFactory.getStrategyNoNullByObj(avg);</span><br><span class="line">log.info(<span class="string">&quot;avg: &#123;&#125;, exp:&#123;&#125;, equals: &#123;&#125;&quot;</span>, avgAns, <span class="number">3.0</span>, avgAns.equals(<span class="number">3.0</span>));</span><br></pre></td></tr></table></figure>

<p>通过测试案例 可以知道，我们现在的话 不是通过自己去调用方法去处理了，而是直接传入对象及其行为，直接返回数据处理结果即可。</p>
<h3 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h3><p>对于 1，我们是采用的 直接回送策略，然后自己进行处理，然后模版是一致的</p>
<p>对于 2，我们采用的是 传入对象，我们直接内部处理 让调用者不需要关心里面具体的逻辑，传入对象即可，然后抽象是多层的，我们可以通过这个定义某一系列的行为，然后去实现</p>
<h2 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis"></a>MyBatis</h2><h3 id="MyBatisPlus-saveBatch-优化"><a href="#MyBatisPlus-saveBatch-优化" class="headerlink" title="MyBatisPlus saveBatch 优化"></a>MyBatisPlus saveBatch 优化</h3><p>设置rewriteBatchedStatements&#x3D;true批量插入</p>
<p>下面我们为数据库的连接加上rewriteBatchedStatements&#x3D;true的属性，再测试批量加入的耗时。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewriteBatchedStatements=true</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/mcband/article/details/131530297">rewriteBatchedStatements</a></p>
<h3 id="Mybatis-插件机制Interceptor与InnerInterceptor"><a href="#Mybatis-插件机制Interceptor与InnerInterceptor" class="headerlink" title="Mybatis 插件机制Interceptor与InnerInterceptor"></a>Mybatis 插件机制Interceptor与InnerInterceptor</h3><p>在 Mybatis 中，插件机制提供了强大的扩展能力，在 sql 最终执行之前，提供了四个拦截点，支持不同场景的功能扩展：</p>
<ul>
<li>Executor (update, query, flushStatements, commit, rollback, getTransaction, close, isClosed)</li>
<li>ParameterHandler (getParameterObject, setParameters)</li>
<li>ResultSetHandler (handleResultSets, handleOutputParameters)</li>
<li>StatementHandler (prepare, parameterize, batch, update, query)</li>
</ul>
<p>例如我们需要对查询出来的数据进行解密（数据库保存的是加密信息，然后我们可以定义一个注解取修饰字段，假如字段被这个注解修饰的话，那么后续的操作我们则需要进行加密解密）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *	解密</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">        @Signature(type = ResultSetHandler.class, method = &quot;handleResultSets&quot;, args = &#123;Statement.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DecryptInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">resultObject</span> <span class="operator">=</span> invocation.proceed();</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(resultObject)) </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (resultObject <span class="keyword">instanceof</span> ArrayList) &#123;</span><br><span class="line">            <span class="comment">//基于selectList</span></span><br><span class="line">            <span class="type">ArrayList</span> <span class="variable">resultList</span> <span class="operator">=</span> (ArrayList) resultObject;</span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(resultList) &amp;&amp; needToDecrypt(resultList.get(<span class="number">0</span>))) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Object result : resultList) &#123;</span><br><span class="line">                    <span class="comment">//逐一解密</span></span><br><span class="line">                    decrypt(result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (needToDecrypt(resultObject)) </span><br><span class="line">            <span class="comment">//基于selectOne</span></span><br><span class="line">            decrypt(resultObject);</span><br><span class="line">        <span class="keyword">return</span> resultObject;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">plugin</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(o, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// function needToDecrypt -&gt; 这个方法其实就是判断字段是否有我们自定义的注解修饰</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 加密和完整性计算拦截器 （目前完整性计算只支持mybatis plus 自带的API）</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EncryptAndVerfyWholenessInterceptor</span> <span class="keyword">extends</span> <span class="title class_">JsqlParserSupport</span> <span class="keyword">implements</span> <span class="title class_">InnerInterceptor</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 变量占位符正则</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">PARAM_PAIRS_RE</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;#\\&#123;ew\\.paramNameValuePairs\\.(&quot;</span> + Constants.WRAPPER_PARAM + <span class="string">&quot;\\d+)\\&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果查询条件是加密数据列，那么要将查询条件进行数据加密。</span></span><br><span class="line"><span class="comment">     * 例如，手机号加密存储后，按手机号查询时，先把要查询的手机号进行加密，再和数据库存储的加密数据进行匹配</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeQuery</span><span class="params">(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;</span><br><span class="line">        <span class="comment">// 具体逻辑 不列出，可查看解密逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增、更新数据时，如果包含隐私数据，则进行加密</span></span><br><span class="line"><span class="comment">     * 还有个问题，进行修改时，如果传过来的实体类的属性有属于脱敏的数据，那么这个脱敏的数据没有被修改的情况下需要被识别出来，不更新到数据库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeUpdate</span><span class="params">(Executor executor, MappedStatement mappedStatement, Object parameterObject)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="comment">// 具体逻辑 不列出，可查看解密逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="关系型数据库实现类动态字段数据库"><a href="#关系型数据库实现类动态字段数据库" class="headerlink" title="关系型数据库实现类动态字段数据库"></a>关系型数据库实现类动态字段数据库</h2><p>为什么需要用到动态数据库呢？</p>
<p>场景：我们有一个需求就是（以前端的视角来描述），前端的需求需要动态渲染指标列，假如后端多了一个指标，那么前端也需要对应上去也多一个列去动态渲染。</p>
<p>​	这个时候对于普通的关系型数据库是做不到的，因为普通的我们指标字段是定下来的，此时的这个老传统数据结构是解决不了这个需求的，那么我和同事想到了可以使用动态模版数据库。（什么是动态模版数据库，其实就是通过定义模版表单，然后具体的表单对应具体的字段指标，然后数据绑定表单与具体的指标列）</p>
<p>那么 —  因为动态数据库对应的数据，一次性填的是一个指标的项，然后到最后查询查询出来的却是列级别数据， 这个时候与前端渲染模式有点出入，那么这个时候我们需要使用到数据翻转。</p>
<p>那么表结构可以参考如下：</p>
<h3 id="指标表"><a href="#指标表" class="headerlink" title="指标表"></a>指标表</h3><table>
<thead>
<tr>
<th>column name</th>
<th>column type</th>
<th>键</th>
<th>desc</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>varchar</td>
<td>PK</td>
<td></td>
</tr>
<tr>
<td>indicator_name</td>
<td>varchar</td>
<td></td>
<td>指标名称</td>
</tr>
<tr>
<td>parent_id</td>
<td>varchar</td>
<td></td>
<td>上级指标</td>
</tr>
<tr>
<td>usable</td>
<td>varchar</td>
<td></td>
<td>是否可用</td>
</tr>
<tr>
<td>sort_num</td>
<td>int</td>
<td></td>
<td>排序字段</td>
</tr>
</tbody></table>
<h3 id="填报表单"><a href="#填报表单" class="headerlink" title="填报表单"></a>填报表单</h3><table>
<thead>
<tr>
<th>column name</th>
<th>column type</th>
<th>键</th>
<th>desc</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>varchar</td>
<td>PK</td>
<td></td>
</tr>
<tr>
<td>form_id</td>
<td>varchar</td>
<td></td>
<td>表单id</td>
</tr>
<tr>
<td>form_desc</td>
<td>varchar</td>
<td></td>
<td>表单描述</td>
</tr>
<tr>
<td>sec_indicator_id</td>
<td>varchar</td>
<td>FK</td>
<td>表单二级指标id</td>
</tr>
<tr>
<td>sec_indicator_name</td>
<td>varchar</td>
<td></td>
<td>表单二级指标名字</td>
</tr>
<tr>
<td>year</td>
<td>int</td>
<td></td>
<td>填报年份(用于统计)</td>
</tr>
<tr>
<td>post_status</td>
<td>varchar</td>
<td></td>
<td>表单发表状态(发布则不可再选，具体业务具体分析)</td>
</tr>
<tr>
<td>usable</td>
<td>varchar</td>
<td></td>
<td>表单是否可用</td>
</tr>
<tr>
<td>editable</td>
<td>varchar</td>
<td></td>
<td>表单是否可编辑</td>
</tr>
<tr>
<td>post_org_id</td>
<td>varchar</td>
<td>FK</td>
<td>表单发布单位id</td>
</tr>
<tr>
<td>post_org_name</td>
<td>varchar</td>
<td></td>
<td>表单发布单位名</td>
</tr>
</tbody></table>
<blockquote>
<p>当前的二级指标指的是：可以理解为一共就只有三个指标，一级指标就是一级路由，然后展开就是二级指标（路由），二级路由对应绑定了页面，页面渲染的是三级指标</p>
</blockquote>
<h3 id="填报数据"><a href="#填报数据" class="headerlink" title="填报数据"></a>填报数据</h3><table>
<thead>
<tr>
<th>column name</th>
<th>column type</th>
<th>键</th>
<th>desc</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>varchar</td>
<td>PK</td>
<td></td>
</tr>
<tr>
<td>form_id</td>
<td>varchar</td>
<td>FK</td>
<td>填报表单id</td>
</tr>
<tr>
<td>form_name</td>
<td>varchar</td>
<td></td>
<td>填报表单名称</td>
</tr>
<tr>
<td>org_id</td>
<td>varchar</td>
<td>FK</td>
<td>填报单位id</td>
</tr>
<tr>
<td>person_id</td>
<td>varchar</td>
<td>FK</td>
<td>填报人id</td>
</tr>
<tr>
<td>indicator_id</td>
<td>varchar</td>
<td>FK</td>
<td>指标id(三级指标)</td>
</tr>
<tr>
<td>data</td>
<td>varchar</td>
<td></td>
<td>指标值(例如: 100)</td>
</tr>
<tr>
<td>status</td>
<td>varchar</td>
<td></td>
<td>数据状态</td>
</tr>
</tbody></table>
<blockquote>
<p>data：为填报的数据</p>
</blockquote>
<p>可能这个表部分地方设计不合理，但是大概步骤是这样的，如果有人看到或者发现有啥建议，可以在下面评论，笔者会第一时间回复（虽然应该没人看😆）</p>
<h2 id="数据翻转与-Stream-流操作"><a href="#数据翻转与-Stream-流操作" class="headerlink" title="数据翻转与 Stream 流操作"></a>数据翻转与 Stream 流操作</h2><h3 id="渲染分析与翻转"><a href="#渲染分析与翻转" class="headerlink" title="渲染分析与翻转"></a>渲染分析与翻转</h3><p>对于我们现在有一个这样的要求就是，我们的数据在第一次处理完成之后是这样的</p>
<table>
<thead>
<tr>
<th>Year</th>
<th>Data [ 对应的指标列，即模版数据库的一行数据 ]</th>
</tr>
</thead>
<tbody><tr>
<td>2023</td>
<td>{ groupName: “指标 1”，value: 100 , other: “其他描述”  }</td>
</tr>
<tr>
<td>2024</td>
<td>{ groupName: “指标 2”，value: 100 , other: “其他描述”  }</td>
</tr>
</tbody></table>
<p>这个一行是指：例如我们在 excel 中，一次填报一行的数据，其中一行就对应一个指标值。此时可以填报多列（多个指标），只不过在数据库中不在同一行存储</p>
<p>可能这个多个指标有点抽象，那么我们在此场景仅理解为一个列即可</p>
<p>上面那个表格也许在数据库中，我们通过联表查询后是这样：</p>
<table>
<thead>
<tr>
<th>year</th>
<th>groupName</th>
<th>value</th>
<th>other</th>
</tr>
</thead>
<tbody><tr>
<td>2023</td>
<td>指标 1</td>
<td>100</td>
<td>其他描述</td>
</tr>
<tr>
<td>2024</td>
<td>指标 1</td>
<td>100</td>
<td>其他描述</td>
</tr>
</tbody></table>
<p>那么对应 Java 中，我们在通过 ORM 框架查询后，转换为 Bean 后，他就是对应一个 List<OurBean> list。其中 bean 很容易知道属性有 year、groupName …</OurBean></p>
<p>此时我们可以通过 stream 流处理数据，把他变成一个 map</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Integer, List&lt;OurBean&gt;&gt; groupByYear = </span><br><span class="line">list.stream().collect(Collectors.groupingBy(OurBean::getYear));</span><br></pre></td></tr></table></figure>

<p>然后就变成一个 Map 了，Key 是我们根据年份分组的，value 就是剩下的字段</p>
<p>此时就是笔者第一次列出来的表格。</p>
<p>如果是这样的结构，返回给前端是这样的</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  code<span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  data<span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        year<span class="punctuation">:</span> <span class="number">2023</span><span class="punctuation">,</span></span><br><span class="line">        otherData<span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          groupName<span class="punctuation">:</span> <span class="string">&quot;指标 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          value<span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">          other<span class="punctuation">:</span> <span class="string">&quot;其他描述&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        year<span class="punctuation">:</span> <span class="number">2024</span><span class="punctuation">,</span></span><br><span class="line">        otherData<span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          groupName<span class="punctuation">:</span> <span class="string">&quot;指标 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          value<span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">          other<span class="punctuation">:</span> <span class="string">&quot;其他描述&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  msg<span class="punctuation">:</span> <span class="string">&quot;查询成功&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>因为前端是渲染表格，我们这样的话，返回的是一个列的数据 [ 就是他们本来就是属于一个指标下的  ]，按照逻辑来说，一个指标下的数据我们应该这样显示</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  code<span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  data<span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;2023&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        groupName<span class="punctuation">:</span> <span class="string">&quot;指标 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        value<span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">        other<span class="punctuation">:</span> <span class="string">&quot;其他描述&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span> </span><br><span class="line">          groupName<span class="punctuation">:</span> <span class="string">&quot;指标 2&quot;</span><span class="punctuation">,</span></span><br><span class="line">          value<span class="punctuation">:</span> <span class="number">300</span><span class="punctuation">,</span></span><br><span class="line">          other<span class="punctuation">:</span> <span class="string">&quot;这是本年度指标二数据下的值(前面没有列出)&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;2024&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        groupName<span class="punctuation">:</span> <span class="string">&quot;指标 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        value<span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">        other<span class="punctuation">:</span> <span class="string">&quot;其他描述&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span> </span><br><span class="line">          groupName<span class="punctuation">:</span> <span class="string">&quot;指标 2&quot;</span><span class="punctuation">,</span></span><br><span class="line">          value<span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">          other<span class="punctuation">:</span> <span class="string">&quot;描述&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  msg<span class="punctuation">:</span> <span class="string">&quot;查询成功&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>就是行级数据，这样才是正常的渲染逻辑，一次性渲染一行，第一次渲染 2023 年度的一指标与二指标的数据，第二次渲染第二行 2024 年度的数据。</p>
<p>对于这种列数据转换行数据，我们同样是使用 map 操作，前面那个渲染结果结构，显然就是 key-value 的结构，只不过 value 是对应多个的情况，那么即可定义</p>
<p>ByYearInnerDataVO：为我们需要的渲染内部结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Integer, List&lt;ByYearInnerDataVO&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>按照年度分组</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, List&lt;PreviCalculateVo&gt;&gt; processMap = </span><br><span class="line">resultList.stream().collect(Collectors.groupingBy(PreviCalculateVo::getYear));</span><br></pre></td></tr></table></figure>

<p>第一层遍历每一个年份组数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, List&lt;PreviCalculateVo&gt;&gt; entry </span><br><span class="line">     : processMap.entrySet()) &#123;</span><br><span class="line">    <span class="comment">// 处理逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二层处理 value 的 list 结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">entry.getValue().forEach((k) -&gt; &#123;</span><br><span class="line">    <span class="comment">// 处理里面的值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后的总体结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, List&lt;PreviCalculateVo&gt;&gt; processMap = resultList.stream().collect(Collectors.groupingBy(PreviCalculateVo::getYear));</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, List&lt;PreviCalculateVo&gt;&gt; entry : processMap.entrySet()) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">year</span> <span class="operator">=</span> Integer.parseInt(entry.getKey());</span><br><span class="line">    entry.getValue().forEach((k) -&gt; &#123;</span><br><span class="line">        List&lt;ByYearInnerDataVO&gt; list = yearIndicatorData.get(year); <span class="comment">// 有此年份数据</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtil.isEmpty(list)) &#123;</span><br><span class="line">            list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">ByYearInnerDataVO</span>()</span><br><span class="line">                .setValue(k.getValue())</span><br><span class="line">                .setData(k.getData()));</span><br><span class="line">        <span class="comment">// replace</span></span><br><span class="line">        result.put(Integer.parseInt(entry.getKey()), list); </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="似山代码"><a href="#似山代码" class="headerlink" title="似山代码"></a>似山代码</h3><p>开始写似山了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5.4 处理不同的长度填充</span></span><br><span class="line"><span class="comment">//        yearIndicatorData.entrySet().stream().map(entry-&gt;&#123;</span></span><br><span class="line"><span class="comment">//            List&lt;ByYearInnerDataVO&gt; collect = entry.getValue().stream().map(i -&gt; &#123;</span></span><br><span class="line"><span class="comment">//                ByYearInnerDataVO empty = new ByYearInnerDataVO();</span></span><br><span class="line"><span class="comment">//                if (!yearAndIndicator.containsKey(i.getIndicatorName())) &#123;</span></span><br><span class="line"><span class="comment">//                    // 则需要补充空</span></span><br><span class="line"><span class="comment">//                    empty.setIndicatorName(i.getIndicatorName());</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//                return empty;</span></span><br><span class="line"><span class="comment">//            &#125;).collect(Collectors.toList());</span></span><br><span class="line"><span class="comment">//            return new AbstractMap.SimpleEntry&lt;&gt;(entry.getKey(), collect);</span></span><br><span class="line"><span class="comment">//        &#125;).collect(Collectors.groupingBy(Map.Entry::getKey, Collectors.mapping(Map.Entry::getValue, Collectors.toList())));</span></span><br><span class="line">Map&lt;Integer, List&lt;ByYearInnerDataVO&gt;&gt; optimizedData = yearIndicatorData.entrySet().stream()</span><br><span class="line">    .collect(Collectors.toMap(Map.Entry::getKey,</span><br><span class="line">        entry -&gt; &#123;</span><br><span class="line">            Set&lt;String&gt; indicator = yearAndIndicator.keySet(); <span class="comment">// 指标对应年份 -- 即补充标准</span></span><br><span class="line">            <span class="keyword">return</span> indicator.stream() <span class="comment">// 创建指标集合的流</span></span><br><span class="line">                    .map(indicatorName -&gt; &#123; <span class="comment">// 对每个指标名进行处理</span></span><br><span class="line">                        <span class="keyword">return</span> entry.getValue().stream() <span class="comment">// 获取当前年份的内部数据列表的流</span></span><br><span class="line">                                .filter(i -&gt; indicatorName.equals(i.getIndicatorName())) <span class="comment">// 过滤出匹配指标名的数据（按照补充标准）</span></span><br><span class="line">                                .findFirst() <span class="comment">// 找到第一个匹配的数据(则不需要处理，使用原有数据即可)</span></span><br><span class="line">                                .orElseGet(() -&gt; &#123; <span class="comment">// 如果没有找到，则创建并返回一个新的ByYearInnerDataVO实例</span></span><br><span class="line">                                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByYearInnerDataVO</span>()</span><br><span class="line">                                            .setIndicatorName(indicatorName) <span class="comment">// 设置指标名</span></span><br><span class="line">                                            .setCount(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">                                            .setRate(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">                                            .setIncr(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">                                            .setValue(<span class="number">0</span>);</span><br><span class="line">                                &#125;); <span class="comment">// 补充空数据</span></span><br><span class="line">                    &#125;).collect(Collectors.toList()); <span class="comment">// 将结果收集成列表</span></span><br><span class="line">        &#125;</span><br><span class="line">    ));</span><br></pre></td></tr></table></figure>

<h3 id="替换方案"><a href="#替换方案" class="headerlink" title="替换方案"></a>替换方案</h3><p>改用传统 for 循环</p>
<p>替换代码如下（减少了流的使用、它需要频繁创建流对象，采用迭代器，，对于业务无关紧要的代码提取）</p>
<p>TIPS： 使用for循环的版本避免了内部流操作的多次迭代，减少了函数调用，并且直接操作了数据结构，这通常会带来更好的性能。在某些情况下，特别是在处理复杂的数据转换和操作时，流可以提供更简洁、更易读的代码。但是，对于性能敏感的操作，特别是在数据量很大时，传统的for循环可能是一个更好的选择。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Integer, List&lt;ByYearInnerDataVO&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;Integer, List&lt;ByYearInnerDataVO&gt;&gt; entry : yearIndicatorData.entrySet()) &#123;</span><br><span class="line">    List&lt;ByYearInnerDataVO&gt; dataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();               <span class="comment">// 对应每一个结果</span></span><br><span class="line">    <span class="keyword">for</span> (String indicatorName : indicatorData) &#123;                        <span class="comment">// 指标标准数据</span></span><br><span class="line">        Optional&lt;ByYearInnerDataVO&gt; found = entry.getValue().stream()</span><br><span class="line">                .filter(i -&gt; indicatorName.equals(i.getIndicatorName()))</span><br><span class="line">                .findFirst();</span><br><span class="line">        dataList.add(found.orElseGet(</span><br><span class="line">            () -&gt; createEmptyData(indicatorName)));					    <span class="comment">// 符合条件则构造空数据</span></span><br><span class="line">    &#125;</span><br><span class="line">    result.put(entry.getKey(), dataList);                               <span class="comment">// 结果封装</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建议使用（手动设置）</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ByYearInnerDataVO <span class="title function_">createEmptyData</span><span class="params">(String indicatorName)</span> &#123;</span><br><span class="line">    <span class="type">ByYearInnerDataVO</span> <span class="variable">innerDataVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByYearInnerDataVO</span>();</span><br><span class="line">    innerDataVO.setIndicatorName(indicatorName);</span><br><span class="line">    innerDataVO.setCount(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">    innerDataVO.setRate(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    innerDataVO.setIncr(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    innerDataVO.setValue(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> innerDataVO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法提取（链式 不建议）</span></span><br><span class="line"><span class="keyword">private</span> ByYearInnerDataVO <span class="title function_">createEmptyData</span><span class="params">(String indicatorName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByYearInnerDataVO</span>()</span><br><span class="line">                .setIndicatorName(indicatorName)</span><br><span class="line">                .setCount(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">                .setRate(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">                .setIncr(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">                .setValue(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再优化（不使用链式调用创建对象，采用手动 填充数据，并且声明为静态类）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ByYearInnerDataVO <span class="title function_">createEmptyData</span><span class="params">(String indicatorName)</span> &#123;</span><br><span class="line">    <span class="type">ByYearInnerDataVO</span> <span class="variable">innerDataVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByYearInnerDataVO</span>();</span><br><span class="line">    innerDataVO.setIndicatorName(indicatorName);</span><br><span class="line">    innerDataVO.setCount(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">    innerDataVO.setRate(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    innerDataVO.setIncr(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    innerDataVO.setValue(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> innerDataVO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Excel-Word-数据相关"><a href="#Excel-Word-数据相关" class="headerlink" title="Excel&#x2F;Word 数据相关"></a>Excel&#x2F;Word 数据相关</h2><h3 id="EasyExcel"><a href="#EasyExcel" class="headerlink" title="EasyExcel"></a>EasyExcel</h3><p>Excel 可以使用阿里的 easyexcel</p>
<details class="folding-tag" green><summary> 这里什么都没有 </summary>
              <div class="content">
              <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.excel.EasyExcel;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.ExcelWriter;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.converters.longconverter.LongStringConverter;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.util.DateUtils;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.write.metadata.WriteSheet;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.write.metadata.fill.FillConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.write.style.column.LongestMatchColumnWidthStyleStrategy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Excel 工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExcelUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 模板填充方式Excel导出</span></span><br><span class="line"><span class="comment">     * 模板注意 用&#123;&#125; 来表示你要用的变量 如果本来就有&quot;&#123;&quot;,&quot;&#125;&quot; 特殊字符 用&quot;\&#123;&quot;,&quot;\&#125;&quot;代替</span></span><br><span class="line"><span class="comment">     * &#123;&#125; 代表普通变量 &#123;.&#125; 代表是list的变量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response 响应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataList 数据行列表（list的变量）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataMap  普通数据变量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filename 文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> templatePath 填充模板路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">templateFillWrite</span><span class="params">(HttpServletResponse response, List&lt;T&gt; dataList, Map&lt;String, Object&gt; dataMap,</span></span><br><span class="line"><span class="params">                                             String filename, String templatePath)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">preFileName</span> <span class="operator">=</span> filename + DateUtils.format(<span class="keyword">new</span> <span class="title class_">Date</span>(),DateUtils.DATE_FORMAT_14);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Content-disposition&quot;</span>, <span class="string">&quot;attachment; filename=&quot;</span> + URLEncoder.encode(preFileName, <span class="string">&quot;UTF-8&quot;</span>) + <span class="string">&quot;.xlsx&quot;</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/vnd.ms-excel;charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ExcelWriter</span> <span class="variable">excelWriter</span> <span class="operator">=</span> EasyExcel</span><br><span class="line">                .write(response.getOutputStream())</span><br><span class="line">                .withTemplate(templatePath)</span><br><span class="line">                .autoCloseStream(Boolean.FALSE) <span class="comment">// 这里需要设置不关闭流</span></span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">WriteSheet</span> <span class="variable">writeSheet</span> <span class="operator">=</span> EasyExcel.writerSheet()</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">// 开启forceNewRow</span></span><br><span class="line">        <span class="type">FillConfig</span> <span class="variable">fillConfig</span> <span class="operator">=</span> FillConfig.builder().forceNewRow(Boolean.TRUE).build();</span><br><span class="line">        <span class="comment">// 写入list数据</span></span><br><span class="line">        excelWriter.fill(dataList,fillConfig,writeSheet);</span><br><span class="line">        <span class="comment">// 填充模板参数</span></span><br><span class="line">        excelWriter.fill(dataMap, writeSheet);</span><br><span class="line">        <span class="comment">//结束</span></span><br><span class="line">        excelWriter.finish();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义表头Excel导出</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response  响应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filename  文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sheetName Excel sheet 名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> head      Excel head 头</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data      数据列表哦</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;       泛型，保证 head 和 data 类型的一致性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 写入失败的情况</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">writeWithCusTomHeader</span><span class="params">(HttpServletResponse response, String filename, String sheetName,</span></span><br><span class="line"><span class="params">                                                 List&lt;List&lt;String&gt;&gt; head, List&lt;T&gt; data)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1.输出 Excel</span></span><br><span class="line">        EasyExcel.write(response.getOutputStream())</span><br><span class="line">                .head(head)</span><br><span class="line">                .autoCloseStream(<span class="literal">false</span>) <span class="comment">// 不要自动关闭，交给 Servlet 自己处理</span></span><br><span class="line">                .registerWriteHandler(<span class="keyword">new</span> <span class="title class_">LongestMatchColumnWidthStyleStrategy</span>()) <span class="comment">// 基于 column 长度，自动适配。最大 255 宽度</span></span><br><span class="line">                .registerConverter(<span class="keyword">new</span> <span class="title class_">LongStringConverter</span>()) <span class="comment">// 避免 Long 类型丢失精度</span></span><br><span class="line">                .sheet(sheetName).doWrite(data);</span><br><span class="line">        <span class="comment">// 2.设置 header 和 contentType。写在最后的原因是，避免报错时，响应 contentType 已经被修改了</span></span><br><span class="line">        response.addHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> + URLEncoder.encode(filename, StandardCharsets.UTF_8.name()));</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/vnd.ms-excel;charset=UTF-8&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将列表以 Excel 响应给前端</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response  响应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filename  文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sheetName Excel sheet 名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> head      Excel head 头</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data      数据列表哦</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;       泛型，保证 head 和 data 类型的一致性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 写入失败的情况</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(HttpServletResponse response, String filename, String sheetName,</span></span><br><span class="line"><span class="params">                                 Class&lt;T&gt; head, List&lt;T&gt; data)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1.输出 Excel</span></span><br><span class="line">        EasyExcel.write(response.getOutputStream(), head)</span><br><span class="line">                .autoCloseStream(<span class="literal">false</span>) <span class="comment">// 不要自动关闭，交给 Servlet 自己处理</span></span><br><span class="line">                .registerWriteHandler(<span class="keyword">new</span> <span class="title class_">LongestMatchColumnWidthStyleStrategy</span>()) <span class="comment">// 基于 column 长度，自动适配。最大 255 宽度</span></span><br><span class="line">                .registerConverter(<span class="keyword">new</span> <span class="title class_">LongStringConverter</span>()) <span class="comment">// 避免 Long 类型丢失精度</span></span><br><span class="line">                .sheet(sheetName).doWrite(data);</span><br><span class="line">        <span class="comment">// 2.设置 header 和 contentType。写在最后的原因是，避免报错时，响应 contentType 已经被修改了</span></span><br><span class="line">        response.addHeader(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment;filename=&quot;</span> + URLEncoder.encode(filename, StandardCharsets.UTF_8.name()));</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/vnd.ms-excel;charset=UTF-8&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">read</span><span class="params">(MultipartFile file, Class&lt;T&gt; head)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> EasyExcel.read(file.getInputStream(), head, <span class="literal">null</span>)</span><br><span class="line">                .autoCloseStream(<span class="literal">false</span>)  <span class="comment">// 不要自动关闭，交给 Servlet 自己处理</span></span><br><span class="line">                .autoTrim(<span class="literal">true</span>) <span class="comment">// 自动去除空格</span></span><br><span class="line">                .sheet()</span><br><span class="line">                .doReadSync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
              </div>
            </details>

<h3 id="Apache-poi"><a href="#Apache-poi" class="headerlink" title="Apache poi"></a>Apache poi</h3><p>Apache poi</p>
<p>如果是需要创建 Word 直接使用下面这个（他是<strong>创建很棒的Word文档</strong>）</p>
<p><a target="_blank" rel="noopener" href="https://deepoove.com/poi-tl">https://deepoove.com/poi-tl</a></p>
<h2 id="类加载读取resource"><a href="#类加载读取resource" class="headerlink" title="类加载读取resource"></a>类加载读取resource</h2><p>有用！（可以与上面的导出生成Excel&#x2F;Word相结合）</p>
<p>如果是使用模板填充的方式，那么需要保存模板，我们则需要读取模板文件，如果传统的放入代码文件夹，我们会发现是打包不了的（笔者血的教训），bane五年则需要采用下面的方式</p>
<p>类加载读取 resource 文件</p>
<p>[springboot项目读取 resources 目录下的文件的9种方式（总结）-阿里云开发者社区 (aliyun.com)](<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/1462486#:~:text=10%EF%BC%9A%E6%80%BB%E7%BB%93">https://developer.aliyun.com/article/1462486#:~:text=10：总结</a> 1 使用 ClassLoader.getResourceAsStream () 方法 这是一种通用的方式，可以适用于大多数情况。 2,目录下的文件，可以使用 Spring 提供的 ClassPathResource 类来加载文件。 这种方式比较简单，不需要提供完整的文件路径。 需要注意的是%3A使用不同的方式需要了解其适用的场景和使用方法。 对于不同的项目和需求，可能需要选择不同的方式。)</p>
<h2 id="XxlJob定时任务"><a href="#XxlJob定时任务" class="headerlink" title="XxlJob定时任务"></a>XxlJob定时任务</h2><h3 id="数据同步方案"><a href="#数据同步方案" class="headerlink" title="数据同步方案"></a>数据同步方案</h3><p>2024.8.12今天mentor给我布置了一个数据同步的任务，其实要做到数据同步，方案还是挺多的，我们可以使用</p>
<p>– 需要内嵌代码</p>
<ol>
<li>Spring Listener发布监听事件</li>
<li>Spring Schedule自带的定时任务</li>
</ol>
<p>– 不需要内嵌代码</p>
<ol>
<li>alibaba canel：监听MySQL的Binlog日志，需要开启MySQL的日志，需要读取二进制文件，可以用 但是不是很友好对于笔者当前的场景</li>
<li>XxlJog：在笔者当场景适合，不在原有的业务逻辑上新增代码，我们只需要定时去轮询数据库的数据（对于仅仅需要操作少量数据），如果你是ToC可能这个轮询数据库的操作不是很适合，对于笔者ToG的项目当然合适，反正用户量也不多，定时同步完全够了</li>
</ol>
<p>我们只需要做到增量同步&#x2F;全量同步即可</p>
<h3 id="动态数据源"><a href="#动态数据源" class="headerlink" title="动态数据源"></a>动态数据源</h3><p>具体如何切换，参考（我们一般在 Service 业务层上控制切换的切面）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@DS(&quot;fzzyk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FzzykSAuRoleServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;FzzykSAuRoleMapper, FzzykSAuRole&gt; <span class="keyword">implements</span> <span class="title class_">FzzykSAuRoleService</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是这样的设置，我们在注入该服务的时候就是用的从数据源，当然还可以在方法上面去使用该注解</p>
<p>例如 MyBatisPlus 提供的样例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@DS(&quot;slave&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@DS(&quot;slave_1&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> List <span class="title function_">selectByCondition</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.queryForList(<span class="string">&quot;select * from user where age &gt;10&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当前执行顺序以局部为主，类上面决定里面默认数据源，方法上决定该局部的数据源</p>
<h3 id="XxlJob-正轨"><a href="#XxlJob-正轨" class="headerlink" title="XxlJob 正轨"></a>XxlJob 正轨</h3><p>具体按照参考[分布式任务调度平台XXL-JOB (xuxueli.com)](<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/#1.5">https://www.xuxueli.com/xxl-job/#1.5</a> 下载)</p>
<p>我们直接把源码拉取过来即可。</p>
<p>在前面的所有步骤都完成之后（即到官网的 HelloWord 步骤时），我们可以开始创建自己的 Job 模块</p>
<p>在把代码拉取下来之后</p>
<p>我们的项目结构是现在这个样子的</p>
<ul>
<li><p>xxl-job</p>
</li>
<li><ul>
<li>xxl-job-admin：网页调度中心</li>
<li>xxl-job-core：公共依赖</li>
<li>xxl-job-executor：我们的 Job 任务模块</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>xxl-job-executor-my-job：我们自己创建的业务</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>怎么创建 Job：[分布式任务调度平台XXL-JOB (xuxueli.com)](<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/#3.2">https://www.xuxueli.com/xxl-job/#3.2</a> BEAN模式（方法形式）)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可参考Sample示例执行器中的 &quot;com.xxl.job.executor.service.jobhandler.SampleXxlJob&quot; ，如下：</span></span><br><span class="line"><span class="meta">@XxlJob(&quot;demoJobHandler&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demoJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    XxlJobHelper.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里了，那么剩下的其实就和普通的 SpringBoot 项目开发业务逻辑一模一样的，我们要操作数据库，那么先定义实体，然后 Service+Mapper（dao）去数据访问以及业务处理。</p>
<p>但是这里我们可以用类似于<strong>工厂模式</strong>的方法去实现动态的对象处理</p>
<p>eg： 假如我们的 Job 是这样的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SAuUserJob</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BasePushExecutor executor;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ISAuUserService sAuUserService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XxlJob(&quot;SAuUserJob&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doJobHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;[系统用户数据同步开始]&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">params</span> <span class="operator">=</span> XxlJobHelper.getJobParam();</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotEmpty(params))</span><br><span class="line">            XxlJobHelper.log(<span class="string">&quot;接收到参数：&quot;</span> + params);</span><br><span class="line">        <span class="comment">// 可以增加参数</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行</span></span><br><span class="line">        executor.baseHandler(sAuUserService, <span class="string">&quot;USER_PUSH&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;[系统用户数据同步结束]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BasePushExecutor 其实就是定义的一个抽象接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BasePushExecutor</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">baseHandler</span><span class="params">(BaseService service, String type)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BasePushExecutorImpl</span> <span class="keyword">implements</span> <span class="title class_">BasePushExecutor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">baseHandler</span><span class="params">(BaseService baseService, String type)</span> &#123;</span><br><span class="line">        baseService.pushData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中这个 baseService 就是具体业务实现类的抽象接口父类</p>
<p>可以理解成为这个结构</p>
<ul>
<li><p>BaseService</p>
</li>
<li><ul>
<li>AService：具体业务 A</li>
<li>BService：具体业务 B</li>
</ul>
</li>
</ul>
<p>我们观察到这个 BaseService 他有一个方法规范为 <code>void pushData();</code></p>
<p>那么我们在使用 MyBatisPlus 的时候，在实现 完 IService 的时候，也得实现 BaseService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ISAuUserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;SAuUser&gt;, BaseService &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>这样的话，在后续继承实现该类的时候，我们只需要实现父类处理业务的接口即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SAuUserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;SAuUserMapper, SAuUser&gt; <span class="keyword">implements</span> <span class="title class_">ISAuUserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;sAuUserServiceTargetlfgj&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> com.xxl.job.executor.dataTarget.service.SAuUserServiceLfgj sAuUserServiceTargetlfgj;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pushData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 具体业务</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>项目结构如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/38974401/1723540515348-ecc7a48d-bef4-4566-b18d-ace311a7ab5d.png" referrerpolicy="no-referrer" alt="img"></p>
<p>笔者的场景：数据同步。</p>
<p>那么对于源数据其实就是原始数据，主数据。</p>
<p>对于目标数据处理，那么不就是把主数据同步到目标数据吗，只不过拉取数据的规范在源数据里面实现了。</p>
<p>对于 XxlJob 业务，其实就是定义控制，类似于 Controller，我们可以在 Web 端控制任务的执行以及参数的传入，根据不同的需求执行不同的业务定义。</p>
<h2 id="异步任务"><a href="#异步任务" class="headerlink" title="异步任务"></a>异步任务</h2><h3 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一次推送</span></span><br><span class="line"><span class="keyword">if</span> (firstPush) &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">startT</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    batchData = <span class="built_in">this</span>.lambdaQuery().eq(STreeNode::getDeleteFlag, <span class="number">0</span>).list();</span><br><span class="line">    List&lt;FzzykSTreeNode&gt; fzzykSTreeNodes = BeanUtil.copyToList(batchData, FzzykSTreeNode.class);</span><br><span class="line">    List&lt;LfgjSTreeNode&gt; lfgjSTreeNodes = BeanUtil.copyToList(batchData, LfgjSTreeNode.class);</span><br><span class="line">    <span class="comment">// ASYNC</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; fzzykFuture = CompletableFuture.runAsync(</span><br><span class="line">            () -&gt; fzzykISTreeNodeService.saveBatch(fzzykSTreeNodes));</span><br><span class="line">    CompletableFuture&lt;Void&gt; lfgjFuture = CompletableFuture.runAsync(</span><br><span class="line">            () -&gt; lfgjistreeNodeService.saveBatch(lfgjSTreeNodes));</span><br><span class="line">    <span class="comment">// Optionally wait for both futures to complete</span></span><br><span class="line">    CompletableFuture.allOf(fzzykFuture, lfgjFuture).join();</span><br><span class="line">    <span class="type">long</span> <span class="variable">endT</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    log.info(<span class="string">&quot;[STreeNode Copy Success!,&#123;&#125;, 执行时间：&#123;&#125; 毫秒&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), (endT - startT));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上述案例中，我们在批量更新&#x2F;插入的时候，可能不是对于一个数据源，当前部分应该与上一个部分以及上上个部分相结合（#MyBatisPlus saveBatch 优化 &amp;&amp; #XxlJob -&gt; 多数据源），实现异步多批量插入，一个任务的执行不会阻塞另外一个</p>
<p>当前方案笔者测试未通过</p>
<h3 id="ThreadPoolTaskExecutor-线程池"><a href="#ThreadPoolTaskExecutor-线程池" class="headerlink" title="ThreadPoolTaskExecutor 线程池"></a>ThreadPoolTaskExecutor 线程池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一次推送</span></span><br><span class="line"><span class="keyword">if</span> (firstPush) &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">startT</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    batchData = <span class="built_in">this</span>.lambdaQuery().eq(STreeNode::getDeleteFlag, <span class="number">0</span>).list();</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtil.isEmpty(batchData)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;FzzykSTreeNode&gt; fzzykSTreeNodes = BeanUtil.copyToList(batchData, FzzykSTreeNode.class);</span><br><span class="line">    List&lt;LfgjSTreeNode&gt; lfgjSTreeNodes = BeanUtil.copyToList(batchData, LfgjSTreeNode.class);</span><br><span class="line">    <span class="type">int</span> <span class="variable">split</span> <span class="operator">=</span> <span class="number">3</span>, size = batchData.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; split; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> i * size / split;</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> (i + <span class="number">1</span>) * size / split;</span><br><span class="line">        executor.execute(() -&gt; &#123;</span><br><span class="line">            fzzykISTreeNodeService.saveBatch(fzzykSTreeNodes.subList(start, end));</span><br><span class="line">            lfgjistreeNodeService.saveBatch(lfgjSTreeNodes.subList(start, end));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">endT</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    log.info(<span class="string">&quot;[STreeNode Copy Success!,&#123;&#125;, 执行时间：&#123;&#125; 毫秒&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(), (endT - startT));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还是这个熟悉，</p>
<h2 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h2><h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="EsUtil"><a href="#EsUtil" class="headerlink" title="EsUtil"></a>EsUtil</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.core.util.ObjectUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.LambdaUtils;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.support.SFunction;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.toolkit.support.SerializedLambda;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Field;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * es工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取es实体类列名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; String <span class="title function_">getColumn</span><span class="params">(SFunction&lt;T, ?&gt; func)</span> &#123;</span><br><span class="line">        <span class="type">SerializedLambda</span> <span class="variable">resolve</span> <span class="operator">=</span> LambdaUtils.resolve(func);</span><br><span class="line">        Class&lt;?&gt; implClass = resolve.getImplClass();</span><br><span class="line">        <span class="type">String</span> <span class="variable">implMethodName</span> <span class="operator">=</span> resolve.getImplMethodName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">fieldName</span> <span class="operator">=</span> getFieldName(implMethodName);</span><br><span class="line">        java.lang.reflect.<span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> implClass.getDeclaredField(fieldName);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldAnno</span> <span class="operator">=</span> field.getAnnotation(Field.class);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != fieldAnno &amp;&amp; ObjectUtil.isNotEmpty(fieldAnno.name())) &#123;</span><br><span class="line">            <span class="keyword">return</span> fieldAnno.name();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getFieldName(implMethodName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getFieldName</span><span class="params">(String getterOrSetterName)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (getterOrSetterName.startsWith(<span class="string">&quot;get&quot;</span>) || getterOrSetterName.startsWith(<span class="string">&quot;set&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> StrUtil.removePreAndLowerFirst(getterOrSetterName, <span class="number">3</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getterOrSetterName.startsWith(<span class="string">&quot;is&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> StrUtil.removePreAndLowerFirst(getterOrSetterName, <span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Invalid Getter or Setter name: &quot;</span> + getterOrSetterName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EsInit"><a href="#EsInit" class="headerlink" title="EsInit"></a>EsInit</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticSearchInit</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建索引库</span></span><br><span class="line"><span class="comment">     * 需要创建一个实体类，其中配置实体类和文档的映射关系，使用注解配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@title</span> createIndex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> restTemplate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> indexName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> T</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createIndex</span><span class="params">(ElasticsearchRestTemplate restTemplate,String indexName, Class T)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!restTemplate.indexOps(IndexCoordinates.of(indexName)).exists())&#123;</span><br><span class="line">            <span class="comment">//创建索引库</span></span><br><span class="line">            restTemplate.indexOps(IndexCoordinates.of(indexName)).create();</span><br><span class="line">            <span class="comment">//设置mapping信息</span></span><br><span class="line">            <span class="type">Document</span> <span class="variable">mapping</span> <span class="operator">=</span> restTemplate.indexOps(IndexCoordinates.of(indexName)).createMapping(T);</span><br><span class="line">            restTemplate.indexOps(IndexCoordinates.of(indexName)).putMapping(mapping);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 只添加索引</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> restTemplate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> indexName</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createIndex</span><span class="params">(ElasticsearchRestTemplate restTemplate,String indexName)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!restTemplate.indexOps(IndexCoordinates.of(indexName)).exists())&#123;</span><br><span class="line">            <span class="comment">//创建索引库</span></span><br><span class="line">            restTemplate.indexOps(IndexCoordinates.of(indexName)).create();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加索引的字段映射</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> restTemplate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> indexName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> T</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createIndexMappings</span><span class="params">(ElasticsearchRestTemplate restTemplate,String indexName, Class T)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!restTemplate.indexOps(IndexCoordinates.of(indexName)).exists())&#123;</span><br><span class="line">            <span class="comment">//设置mapping信息</span></span><br><span class="line">            <span class="type">Document</span> <span class="variable">mapping</span> <span class="operator">=</span> restTemplate.indexOps(IndexCoordinates.of(indexName)).createMapping(T);</span><br><span class="line">            restTemplate.indexOps(IndexCoordinates.of(indexName)).putMapping(mapping);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除索引库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@title</span> deleteIndex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> restTemplate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> indexName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deleteIndex</span><span class="params">(ElasticsearchRestTemplate restTemplate,String indexName)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (restTemplate.indexOps(IndexCoordinates.of(indexName)).exists())&#123;</span><br><span class="line">            restTemplate.indexOps(IndexCoordinates.of(indexName)).delete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">XxxxSearchRepository</span></span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">ElasticsearchRepository</span>&lt;XxxxSearch, String&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么这个其实就是有点类似于 MyBatisPlus 那一套</p>
<p>其中Repository 就是实现的他原封装的</p>
<p>操作：Controller -&gt; Service -&gt; Repository</p>
<p>到这里 基本结构已经没什么问题了</p>
<h3 id="分页查询-高亮-内联查询"><a href="#分页查询-高亮-内联查询" class="headerlink" title="分页查询 + 高亮 + 内联查询"></a>分页查询 + 高亮 + 内联查询</h3><p>例如我现在有一个需求，我需要查询 一页二十条数据 并且 我需要查询的字段为 Name 其中查询出来的数据得高亮</p>
<p>那么对于构建复杂的查询，笔者是推荐使用NativeSearchQueryBuilder 结合 BoolQueryBuilder。</p>
<p>那么大体结构我们可以这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造最后查询条件</span></span><br><span class="line"><span class="type">NativeSearchQueryBuilder</span> <span class="variable">queryBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativeSearchQueryBuilder</span>();</span><br><span class="line"><span class="comment">// 设置分页参数</span></span><br><span class="line">queryBuilder.withPageable(PageRequest.of((page - <span class="number">1</span>), size));</span><br></pre></td></tr></table></figure>

<h4 id="收集内联条件"><a href="#收集内联条件" class="headerlink" title="收集内联条件"></a>收集内联条件</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BoolQueryBuilder</span> <span class="variable">boolQueryBuilder</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line"><span class="type">BoolQueryBuilder</span> <span class="variable">innerQuery</span> <span class="operator">=</span> QueryBuilders.boolQuery();</span><br><span class="line"><span class="keyword">if</span> (!StrUtil.isEmptyOrUndefined(name)) &#123;</span><br><span class="line">    <span class="comment">// 内条件查询</span></span><br><span class="line">    innerQuery.must(QueryBuilders.matchQuery(</span><br><span class="line">            EsUtil.getColumn(XxxxSearch::getName), <span class="comment">// 查询字段</span></span><br><span class="line">            name</span><br><span class="line">    ));</span><br><span class="line">    highlightBuilder.field(EsUtil.getColumn(XxxxSearch::getName))</span><br><span class="line">            .preTags(<span class="string">&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;</span>)<span class="comment">// 设置高亮 颜色</span></span><br><span class="line">            .postTags(<span class="string">&quot;&lt;/span&gt;&quot;</span>)</span><br><span class="line">            .numOfFragments(<span class="number">0</span>)</span><br><span class="line">            .fragmentSize(<span class="number">250</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 例如</span></span><br><span class="line">boolQueryBuilder.must(innerQuery()); <span class="comment">// 这个must可以更换为其他的 具体见官网</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 小结：对于需要构造复杂的查询，我们可以使用BoolQueryBuilder套BoolQueryBuilder进行筛选</span></span><br></pre></td></tr></table></figure>

<p>然后条件补充完之后，再吧当前内条件（innerQuery）给封装到外条件（boolQueryBuilder）中，最后在封装到原生查询条件（NativeSearchQueryBuilder）中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询条件收集</span></span><br><span class="line">queryBuilder.withQuery(boolQueryBuilder);</span><br><span class="line"><span class="comment">// 高亮条件收集</span></span><br><span class="line">queryBuilder.withHighlightBuilder(highlightBuilder); </span><br><span class="line"><span class="comment">// 根据得分排序</span></span><br><span class="line">queryBuilder.withSort(SortBuilders.fieldSort(<span class="string">&quot;_score&quot;</span>).order(SortOrder.DESC)); </span><br></pre></td></tr></table></figure>

<h4 id="结果集查询"><a href="#结果集查询" class="headerlink" title="结果集查询"></a>结果集查询</h4><p>此时则不能使用旧的那个 search（即实现了ElasticsearchRepository 的那个类，因为它在高版本已经被废弃了），我们可以采用注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ElasticsearchRestTemplate elasticsearchTemplate;</span><br></pre></td></tr></table></figure>

<p>然后所以这个模版方法进行查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SearchHits&lt;XxxxSearch&gt; searchHits = elasticsearchTemplate.search(queryBuilder.build(),</span><br><span class="line">                XxxxSearch.class);</span><br></pre></td></tr></table></figure>

<h4 id="处理高亮"><a href="#处理高亮" class="headerlink" title="处理高亮"></a>处理高亮</h4><p>高亮其实就行遍历我们刚刚拿到的SearchHits，然后里面会有一个getHighlightFields( )</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (SearchHit&lt;XxxxSearch&gt; searchHit : searchHits) &#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//高亮的内容</span></span><br><span class="line">    Map&lt;String, List&lt;String&gt;&gt; highlightFields = searchHit.getHighlightFields();</span><br><span class="line">    <span class="type">XxxxSearch</span> <span class="variable">obj</span> <span class="operator">=</span> searchHit.getContent();</span><br><span class="line">    map.put(<span class="string">&quot;id&quot;</span>, obj.getId());</span><br><span class="line">    <span class="comment">// Flag1可以理解为：我这个字段是否参与了高亮的操作</span></span><br><span class="line">    map.put(<span class="string">&quot;name&quot;</span>, flag1 ? highlightFields.get(<span class="string">&quot;name&quot;</span>).get(<span class="number">0</span>) : obj.getName());</span><br><span class="line">    <span class="comment">// 结果列表封装</span></span><br><span class="line">    titleMaps.add(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分页对象封装"><a href="#分页对象封装" class="headerlink" title="分页对象封装"></a>分页对象封装</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PageInfo&lt;Map&lt;String, Object&gt;&gt; info = <span class="keyword">new</span> <span class="title class_">PageInfo</span>&lt;&gt;();</span><br><span class="line">info.setSize((<span class="type">int</span>) searchHits.getTotalHits()); <span class="comment">// CurrentSize</span></span><br><span class="line">info.setList(titleMaps);			           <span class="comment">// 刚刚处理完高亮的结果</span></span><br><span class="line">info.setTotal(searchHits.getTotalHits());      <span class="comment">// Total</span></span><br><span class="line">info.setPageSize(size);	                       <span class="comment">// PageSize		</span></span><br><span class="line">info.setPageNum(page);	                       <span class="comment">// PageNum</span></span><br><span class="line"><span class="keyword">return</span> info;</span><br></pre></td></tr></table></figure>

<h3 id="可视化-Edge-小插件"><a href="#可视化-Edge-小插件" class="headerlink" title="可视化 Edge 小插件"></a>可视化 Edge 小插件</h3><p>去拓展商店搜索 ‘es-client’即可下载，连接即可使用</p>
<h3 id="问题项"><a href="#问题项" class="headerlink" title="问题项"></a>问题项</h3><ol>
<li>如果你的实体字段日期属性使用的是 Date，那么在格式化的时候会出现异常。</li>
</ol>
<p>解决方案：改为LocalDate</p>
<ol>
<li>对于 ES 的数据同步问题：我们有两个方案 ① 一个是前端对于一个数据库操作发送两个请求（一个是操作数据库，一个是对于刚刚的数据进行 es 同步）② 后端操作：我们可以在需要数据同步的方法里同步进行 es 和 sql 操作。</li>
</ol>
<p>很显然：② 比较合适，因为前端可能会因为网络波动而导致第二个请求失效。</p>
<h2 id="做聊天项目遇到一些题"><a href="#做聊天项目遇到一些题" class="headerlink" title="做聊天项目遇到一些题"></a>做聊天项目遇到一些题</h2><h3 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h3><p>RequestHolder的内部类为 ThreadLocal, ThreadLocal的key为弱引用, Value为强引用,  面试题:  ThreadLocal为什么会内存泄漏?</p>
<h3 id="Redis与MySQL的数据一致性"><a href="#Redis与MySQL的数据一致性" class="headerlink" title="Redis与MySQL的数据一致性"></a>Redis与MySQL的数据一致性</h3><ul>
<li><p>先删后更<br>先删除缓存，后更新数据库<br>可以采用的方案：延迟双删</p>
</li>
<li><p>先更后删<br>先更新数据库，后删除缓存<br>采用中间添加一个消息中间件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">数据库        生产消息        消息中间件     消费消息       缓存</span><br><span class="line">SQL -&gt; (推送需要删除缓存的消息)-&gt; MQ -&gt; (消费推送的消息) —&gt; 更新Redis </span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="进程-线程-多线程"><a href="#进程-线程-多线程" class="headerlink" title="进程 线程 多线程"></a>进程 线程 多线程</h3><p>进程：是系统运行的基本单位，例如 qq 等，他运行其实就可以看作成进程，从 qq 的运行到结束的过程可以看作成进程的创建到消亡的过程，其中进程可以包含很多个线程组成<br>线程：进程和线程很像，但是线程是一个比进程更小的执行单位。</p>
<h4 id="什么时候使用多线程，什么时候使用多进程？"><a href="#什么时候使用多线程，什么时候使用多进程？" class="headerlink" title="什么时候使用多线程，什么时候使用多进程？"></a>什么时候使用多线程，什么时候使用多进程？</h4><p>● 多线程<br>对于 I&#x2F;O 密集型，因为需要大量的 IO 操作，在进行 IO 操作时候 CPU 处于空闲状态，那么可以交给其他的线程去执行<br>● 多进程<br>对于 CPU 密集型，他需要大量的 CPU 计算，那么可以充分利用多进程进行计算，提升效率（多核 CPU）<br>当需要并行计算的时候也可以使用多进程</p>
<h3 id="如何查看死锁？判断发生了死锁？"><a href="#如何查看死锁？判断发生了死锁？" class="headerlink" title="如何查看死锁？判断发生了死锁？"></a>如何查看死锁？判断发生了死锁？</h3><p>● Jconsole：jdk 自带的图形化界面<br>● jstack：jps -ef | grep 进程 id</p>
<h3 id="项目部署上去了，有用过日志吗？怎么在服务器查看日志？"><a href="#项目部署上去了，有用过日志吗？怎么在服务器查看日志？" class="headerlink" title="项目部署上去了，有用过日志吗？怎么在服务器查看日志？"></a>项目部署上去了，有用过日志吗？怎么在服务器查看日志？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tail -f xxx.log    # 动态查看日志</span><br><span class="line">tail -10 xxx.log   # 查看最后10行日志</span><br><span class="line">tail -n 10 xxx.log # 查看最后10行日志</span><br></pre></td></tr></table></figure>

<p>引申 ：</p>
<p>如果需要查看某进程（例如需要查看 java 的进程）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep java</span><br></pre></td></tr></table></figure>

<p>如果需要不挂起运行，然后后台可以指定日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup /root/runoob.sh &gt; runoob.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<p>如需检查 CPU 使用 top 和 cat（特定路径）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">＃ 通过proc文件系统</span><br><span class="line">cat /proc/cpuinfo #查看cpu信息</span><br><span class="line">cat /proc/meminfo #查看memery信息</span><br></pre></td></tr></table></figure>

<ul>
<li>top</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># top效果</span><br><span class="line">top - 21:35:19 up 12 days,  2:19,  1 user,  load average: 0.00, 0.00, 0.00</span><br><span class="line">Tasks: 107 total,   1 running, 106 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  0.3 us,  0.2 sy,  0.0 ni, 99.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">MiB Mem :   1890.1 total,     77.4 free,   1505.6 used,    307.2 buff/cache</span><br><span class="line">MiB Swap:      0.0 total,      0.0 free,      0.0 used.    231.7 avail Mem </span><br><span class="line"></span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND               </span><br><span class="line">   7634 root      20   0  137292  21596   9016 S   0.7   1.1  97:19.68 AliYunDunMonito       </span><br><span class="line">   2086 root      20   0 1287708  10156   7096 S   0.3   0.5  79:23.59 argusagent            </span><br><span class="line">   7623 root      20   0   94708   8892   6384 S   0.3   0.5  58:19.71 AliYunDun             </span><br><span class="line">   8415 root      20   0  689932   9512   6064 S   0.3   0.5  11:25.31 aliyun-service        </span><br><span class="line">   8596 root      20   0   19432   2696   1740 S   0.3   0.1   2:17.24 assist_daemon         </span><br><span class="line">  21434 root      20   0 3348728 885380   9064 S   0.3  45.7  26:24.20 java                  </span><br><span class="line">  32110 root      20   0   11844   3764   3104 R   0.3   0.2   0:00.01 top</span><br></pre></td></tr></table></figure>

<p>内存使用 top free cat（特定路径）</p>
<ul>
<li>free -h</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">free -h  #h：以人类可读的单位显示例如1G 23M</span><br><span class="line">root@xxxxxxxx:~# free -h</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:          1.8Gi       1.5Gi        77Mi       2.0Mi       307Mi       232Mi</span><br><span class="line">Swap:            0B          0B          0B</span><br></pre></td></tr></table></figure>

<ul>
<li>free -m</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">free -m  #m：以mb为单位显示</span><br><span class="line">root@xxxxxxxx:~# free -m</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           1890        1504          77           2         307         232</span><br></pre></td></tr></table></figure>

<h3 id="查看Java进程相关"><a href="#查看Java进程相关" class="headerlink" title="查看Java进程相关"></a>查看Java进程相关</h3><p>查看java后端服务对应的进程ID</p>
<ul>
<li>jps -l<br>生成线程快照 并保存为文件</li>
<li>jstack 进程id &gt;dump_threads.txt</li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/03/07/tFEYfQsaBHWV14x.webp" referrerpolicy="no-referrer" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/03/07/tFEYfQsaBHWV14x.webp" referrerpolicy="no-referrer" title="头像" alt="头像"></a><div class="post-copyright__author_name">Calyee</div><div class="post-copyright__author_desc">追求充实，分享快乐</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.calyee.top/2024/07/11/%E9%A1%B9%E7%9B%AE%E6%94%B6%E8%8E%B7/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.calyee.top/2024/07/11/%E9%A1%B9%E7%9B%AE%E6%94%B6%E8%8E%B7/')">项目收获</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="/img/pay/wx.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/pay/wx.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/pay/zfb.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/pay/zfb.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.calyee.top/2024/07/11/%E9%A1%B9%E7%9B%AE%E6%94%B6%E8%8E%B7/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=项目收获&amp;url=https://blog.calyee.top/2024/07/11/%E9%A1%B9%E7%9B%AE%E6%94%B6%E8%8E%B7/&amp;pic=https://pic.imge.cc/2024/07/12/669124e9199ae.webp" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.calyee.top" target="_blank">Calyee`Blog</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/MyBatis/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>MyBatis<span class="tagsPageCount">2</span></a><a class="post-meta__box__tags" href="/tags/%E9%A1%B9%E7%9B%AE/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>项目<span class="tagsPageCount">3</span></a><a class="post-meta__box__tags" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>设计模式<span class="tagsPageCount">2</span></a><a class="post-meta__box__tags" href="/tags/%E6%B8%B8%E6%A0%87%E7%BF%BB%E9%A1%B5/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>游标翻页<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E6%A8%A1%E6%9D%BF%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>模板数据库<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/MySQL/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>MySQL<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://pic.imge.cc/2024/07/12/669124e9199ae.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2023/09/25/MyBatisPlus/" title="MyBatisPlus"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://yikoutian1.github.io/2023/10/05/Redis/mybatisplus.svg" referrerpolicy="no-referrer" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-09-25</div><div class="title">MyBatisPlus</div></div></a></div><div><a href="/2023/12/19/%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/" title="项目相关"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://wallpapercave.com/wp/wp7944798.jpg" referrerpolicy="no-referrer" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-19</div><div class="title">项目相关</div></div></a></div><div><a href="/2023/12/17/%E5%BE%AE%E4%BF%A1%E6%89%AB%E7%A0%81%E7%99%BB%E5%BD%95/" title="基于SpringBoot实现简单微信扫码登录"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://weixin.qq.com/zh_CN/htmledition/images/wechat_logo_109.2x219536.png" referrerpolicy="no-referrer" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-17</div><div class="title">基于SpringBoot实现简单微信扫码登录</div></div></a></div><div><a href="/2023/12/19/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="设计模式"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://wallpapercave.com/uwp/uwp4120708.jpeg" referrerpolicy="no-referrer" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-19</div><div class="title">设计模式</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" style="display: none">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/03/07/tFEYfQsaBHWV14x.webp" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2021/01/15/76dea70f28eed.png" referrerpolicy="no-referrer" ait="status"/></div></div><div class="author-info__description">记录一个有趣的点滴</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Calyee</h1><div class="author-info__desc">追求充实，分享快乐</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/yikoutian1" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://blog.csdn.net/Des_Pacito" target="_blank" title="CSDN"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div></div></div></div><div class="card-widget card-revolve"><div class="twopeople" style="margin: 0;align-items: center;justify-content: center;text-align: center; background: linear-gradient(to bottom, #D9A7C7, #FFFCDC);"><div class="container" style="height: 50px; margin: 0; align-items: center; justify-content: center; text-align: center;"><h2>不定期更新博客,欢迎互换<a href="https://blog.calyee.top/link/">友链.</a></h2></div><canvas class="illo" width="600" height="600" style="display: block;margin: 0 auto;cursor: move;max-width: 200px; max-height: 200px; touch-action: none; width: 480px; height: 480px;"></canvas></div></div><script src="https://npm.elemecdn.com/justlovesmile-static/js/twopeople1.js"></script>
<script src="https://npm.elemecdn.com/justlovesmile-static/js/zdog.dist.js"></script>
<script id="rendered-js" src="https://npm.elemecdn.com/justlovesmile-static/js/twopeople.js"></script><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content"><div id="welcome-info"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.</span> <span class="toc-text">Git常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Arthas"><span class="toc-number">2.</span> <span class="toc-text">Arthas</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">2.2.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Arthas%EF%BC%88%E9%98%BF%E5%B0%94%E8%90%A8%E6%96%AF%EF%BC%89%E8%83%BD%E4%B8%BA%E4%BD%A0%E5%81%9A%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.3.</span> <span class="toc-text">Arthas（阿尔萨斯）能为你做什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDEA-%E6%8F%92%E4%BB%B6%E8%BE%85%E5%8A%A9"><span class="toc-number">2.4.</span> <span class="toc-text">IDEA 插件辅助</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">2.5.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">2.6.</span> <span class="toc-text">使用命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B8%E6%A0%87%E7%BF%BB%E9%A1%B5"><span class="toc-number">3.</span> <span class="toc-text">游标翻页</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E7%BF%BB%E9%A1%B5%E9%97%AE%E9%A2%98"><span class="toc-number">3.1.</span> <span class="toc-text">深翻页问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B8%E6%A0%87%E7%BF%BB%E9%A1%B5%E8%A7%A3%E5%86%B3%E6%B7%B1%E7%BF%BB%E9%A1%B5%E9%97%AE%E9%A2%98"><span class="toc-number">3.2.</span> <span class="toc-text">游标翻页解决深翻页问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E7%B1%BB%E5%B0%81%E8%A3%85"><span class="toc-number">3.3.</span> <span class="toc-text">工具类封装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%81%E8%A3%85Starter"><span class="toc-number">4.</span> <span class="toc-text">封装Starter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AQS"><span class="toc-number">5.</span> <span class="toc-text">AQS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AQS-%E7%B1%BB%E5%AE%9A%E4%B9%89%E4%BB%A5%E5%8F%8A-Node-%E8%8A%82%E7%82%B9%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E"><span class="toc-number">5.1.</span> <span class="toc-text">AQS 类定义以及 Node 节点数据结构说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8EReentrantLock%E7%9A%84%E9%9D%9E%E5%85%AC%E5%B9%B3%E7%8B%AC%E5%8D%A0%E9%94%81%E5%AE%9E%E7%8E%B0%E6%9D%A5%E7%9C%8BAQS%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">5.2.</span> <span class="toc-text">从ReentrantLock的非公平独占锁实现来看AQS的原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E7%B1%BB%E7%9A%84%E4%BD%BF%E7%94%A8-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">6.</span> <span class="toc-text">抽象类的使用(最佳实践)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87RequestHolder"><span class="toc-number">7.</span> <span class="toc-text">请求上下文RequestHolder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%8A%E5%A4%A9%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F%E5%92%8C%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E7%BB%84%E5%90%88"><span class="toc-number">8.</span> <span class="toc-text">聊天项目中的工厂模式和策略模式组合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E5%B7%A5%E5%8E%82%E5%8A%A0%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F"><span class="toc-number">9.</span> <span class="toc-text">实际开发中的工厂加策略模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F-1-%E7%AD%96%E7%95%A5%E6%8A%BD%E8%B1%A1%E4%B8%80%E5%B1%82"><span class="toc-number">9.1.</span> <span class="toc-text">工厂模式 1(策略抽象一层)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F-2-%E7%AD%96%E7%95%A5%E6%8A%BD%E8%B1%A1%E4%B8%A4%E5%B1%82-%E5%8F%AF%E6%8B%93%E5%B1%95%E6%80%A7%E6%9B%B4%E5%BC%BA"><span class="toc-number">9.2.</span> <span class="toc-text">工厂模式 2(策略抽象两层 可拓展性更强)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E6%80%BB%E7%BB%93"><span class="toc-number">9.3.</span> <span class="toc-text">小总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MyBatis"><span class="toc-number">10.</span> <span class="toc-text">MyBatis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MyBatisPlus-saveBatch-%E4%BC%98%E5%8C%96"><span class="toc-number">10.1.</span> <span class="toc-text">MyBatisPlus saveBatch 优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mybatis-%E6%8F%92%E4%BB%B6%E6%9C%BA%E5%88%B6Interceptor%E4%B8%8EInnerInterceptor"><span class="toc-number">10.2.</span> <span class="toc-text">Mybatis 插件机制Interceptor与InnerInterceptor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0%E7%B1%BB%E5%8A%A8%E6%80%81%E5%AD%97%E6%AE%B5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">11.</span> <span class="toc-text">关系型数据库实现类动态字段数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E6%A0%87%E8%A1%A8"><span class="toc-number">11.1.</span> <span class="toc-text">指标表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A1%AB%E6%8A%A5%E8%A1%A8%E5%8D%95"><span class="toc-number">11.2.</span> <span class="toc-text">填报表单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A1%AB%E6%8A%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">11.3.</span> <span class="toc-text">填报数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BF%BB%E8%BD%AC%E4%B8%8E-Stream-%E6%B5%81%E6%93%8D%E4%BD%9C"><span class="toc-number">12.</span> <span class="toc-text">数据翻转与 Stream 流操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E5%88%86%E6%9E%90%E4%B8%8E%E7%BF%BB%E8%BD%AC"><span class="toc-number">12.1.</span> <span class="toc-text">渲染分析与翻转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%BC%E5%B1%B1%E4%BB%A3%E7%A0%81"><span class="toc-number">12.2.</span> <span class="toc-text">似山代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E6%96%B9%E6%A1%88"><span class="toc-number">12.3.</span> <span class="toc-text">替换方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Excel-Word-%E6%95%B0%E6%8D%AE%E7%9B%B8%E5%85%B3"><span class="toc-number">13.</span> <span class="toc-text">Excel&#x2F;Word 数据相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EasyExcel"><span class="toc-number">13.1.</span> <span class="toc-text">EasyExcel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache-poi"><span class="toc-number">13.2.</span> <span class="toc-text">Apache poi</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E8%AF%BB%E5%8F%96resource"><span class="toc-number">14.</span> <span class="toc-text">类加载读取resource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XxlJob%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">15.</span> <span class="toc-text">XxlJob定时任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E6%96%B9%E6%A1%88"><span class="toc-number">15.1.</span> <span class="toc-text">数据同步方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">15.2.</span> <span class="toc-text">动态数据源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XxlJob-%E6%AD%A3%E8%BD%A8"><span class="toc-number">15.3.</span> <span class="toc-text">XxlJob 正轨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1"><span class="toc-number">16.</span> <span class="toc-text">异步任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CompletableFuture"><span class="toc-number">16.1.</span> <span class="toc-text">CompletableFuture</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadPoolTaskExecutor-%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">16.2.</span> <span class="toc-text">ThreadPoolTaskExecutor 线程池</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch"><span class="toc-number">17.</span> <span class="toc-text">ElasticSearch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96"><span class="toc-number">17.1.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EsUtil"><span class="toc-number">17.2.</span> <span class="toc-text">EsUtil</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EsInit"><span class="toc-number">17.3.</span> <span class="toc-text">EsInit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2-%E9%AB%98%E4%BA%AE-%E5%86%85%E8%81%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">17.4.</span> <span class="toc-text">分页查询 + 高亮 + 内联查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B6%E9%9B%86%E5%86%85%E8%81%94%E6%9D%A1%E4%BB%B6"><span class="toc-number">17.4.1.</span> <span class="toc-text">收集内联条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E9%9B%86%E6%9F%A5%E8%AF%A2"><span class="toc-number">17.4.2.</span> <span class="toc-text">结果集查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E9%AB%98%E4%BA%AE"><span class="toc-number">17.4.3.</span> <span class="toc-text">处理高亮</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E5%AF%B9%E8%B1%A1%E5%B0%81%E8%A3%85"><span class="toc-number">17.4.4.</span> <span class="toc-text">分页对象封装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96-Edge-%E5%B0%8F%E6%8F%92%E4%BB%B6"><span class="toc-number">17.5.</span> <span class="toc-text">可视化 Edge 小插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E9%A1%B9"><span class="toc-number">17.6.</span> <span class="toc-text">问题项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%9A%E8%81%8A%E5%A4%A9%E9%A1%B9%E7%9B%AE%E9%81%87%E5%88%B0%E4%B8%80%E4%BA%9B%E9%A2%98"><span class="toc-number">18.</span> <span class="toc-text">做聊天项目遇到一些题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreadLocal"><span class="toc-number">18.1.</span> <span class="toc-text">ThreadLocal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E4%B8%8EMySQL%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">18.2.</span> <span class="toc-text">Redis与MySQL的数据一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B-%E7%BA%BF%E7%A8%8B-%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">18.3.</span> <span class="toc-text">进程 线程 多线程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B%EF%BC%8C%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%BF%9B%E7%A8%8B%EF%BC%9F"><span class="toc-number">18.3.1.</span> <span class="toc-text">什么时候使用多线程，什么时候使用多进程？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E6%AD%BB%E9%94%81%EF%BC%9F%E5%88%A4%E6%96%AD%E5%8F%91%E7%94%9F%E4%BA%86%E6%AD%BB%E9%94%81%EF%BC%9F"><span class="toc-number">18.4.</span> <span class="toc-text">如何查看死锁？判断发生了死锁？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B8%8A%E5%8E%BB%E4%BA%86%EF%BC%8C%E6%9C%89%E7%94%A8%E8%BF%87%E6%97%A5%E5%BF%97%E5%90%97%EF%BC%9F%E6%80%8E%E4%B9%88%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%EF%BC%9F"><span class="toc-number">18.5.</span> <span class="toc-text">项目部署上去了，有用过日志吗？怎么在服务器查看日志？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8BJava%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3"><span class="toc-number">18.6.</span> <span class="toc-text">查看Java进程相关</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/07/11/%E9%A1%B9%E7%9B%AE%E6%94%B6%E8%8E%B7/" title="项目收获"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic.imge.cc/2024/07/12/669124e9199ae.webp" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="项目收获"/></a><div class="content"><a class="title" href="/2024/07/11/%E9%A1%B9%E7%9B%AE%E6%94%B6%E8%8E%B7/" title="项目收获">项目收获</a><time datetime="2024-07-11T11:46:04.562Z" title="发表于 2024-07-11 11:46:04">2024-07-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/28/Jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/" title="Jenkins自动化部署"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/06/28/9hKMSIjCY21vV5Q.webp" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Jenkins自动化部署"/></a><div class="content"><a class="title" href="/2024/06/28/Jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/" title="Jenkins自动化部署">Jenkins自动化部署</a><time datetime="2024-06-28T13:24:29.051Z" title="发表于 2024-06-28 13:24:29">2024-06-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/04/JavaJVM/" title="Java性能优化JVM相关"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/05/04/3o5pJRMXxQrcaFD.webp" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java性能优化JVM相关"/></a><div class="content"><a class="title" href="/2024/05/04/JavaJVM/" title="Java性能优化JVM相关">Java性能优化JVM相关</a><time datetime="2024-05-04T13:24:29.051Z" title="发表于 2024-05-04 13:24:29">2024-05-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/30/LeetCode/" title="LeetCode"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/05/07/8X4yGfg9w1TuRDQ.webp" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LeetCode"/></a><div class="content"><a class="title" href="/2024/04/30/LeetCode/" title="LeetCode">LeetCode</a><time datetime="2024-04-30T11:46:04.562Z" title="发表于 2024-04-30 11:46:04">2024-04-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/17/Dubbo%E4%B8%8EZookeeper/" title="Dubbo与Zookeeper"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/04/17/bvKw6WxmqnsJVZI.webp" referrerpolicy="no-referrer" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Dubbo与Zookeeper"/></a><div class="content"><a class="title" href="/2024/04/17/Dubbo%E4%B8%8EZookeeper/" title="Dubbo与Zookeeper">Dubbo与Zookeeper</a><time datetime="2024-04-17T11:46:04.562Z" title="发表于 2024-04-17 11:46:04">2024-04-17</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:qiulihang1@foxmail.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://s2.loli.net/2024/03/07/tFEYfQsaBHWV14x.webp" referrerpolicy="no-referrer" size="50px"/><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/yikoutian1" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener" href="https://www.foreverblog.cn/">十年之约</a><a class="footer-item" title="开往" target="_blank" rel="noopener" href="https://github.com/travellings-link/travellings">开往</a></div></div><div class="footer-group"><div class="footer-title">关于</div><div class="footer-links"><a class="footer-item" title="关于我" href="/about/">关于我</a><a class="footer-item" title="留言板" href="/comments/">留言板</a><a class="footer-item" title="总览" href="/archives/">总览</a><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="友链" href="/link/">友链</a><a class="footer-item" title="游戏空间" href="/games/">游戏空间</a><a class="footer-item" title="待办清单" href="/todolist/">待办清单</a><a class="footer-item" title="我的装备" href="/equipment/">我的装备</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/badge/calyee-上班摸鱼中.svg" alt="大佬带带我~" title="大佬带带我~"/><div id="runtimeTextTip"></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" referrerpolicy="no-referrer" alt="博客框架为Hexo_v5.4.0"/></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" referrerpolicy="no-referrer" alt="本站使用AnZhiYu主题"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" referrerpolicy="no-referrer" alt="本站项目由Github托管"/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20240099" style="margin-inline:5px" data-title="萌ICP备" title="萌ICP备"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog.calyee.top/img/20240099.svg" alt="萌ICP备"/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" referrerpolicy="no-referrer" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2024 By <a class="footer-bar-link" href="/" title="Calyee" target="_blank">Calyee</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = ["欲寄彩笺兼尺素，山长水阔知何处。","出自 晏殊·蝶恋花·槛菊愁烟兰泣露"]
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.0.15/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://calyee-image.pages.dev/" title="图床">图床</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://icp.gov.moe/?keyword=20240099" title="萌ICP备-20240099号">萌ICP备-20240099号</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://guan.ma/hao/2024000170" title="官码2024000170号">官码2024000170号</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">31</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">39</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">18</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="http://blog.calyee.top/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">直达链接</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/Yikoutian1/" title="Github"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" referrerpolicy="no-referrer" alt="Github"/><span class="back-menu-item-text">Github</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://chat.calyee-blog.top/" title="ChatGPT"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://freelogopng.com/images/all_img/1681038242chatgpt-logo-png.png" referrerpolicy="no-referrer" alt="ChatGPT"/><span class="back-menu-item-text">ChatGPT</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://calyee-image.pages.dev/" title="Images"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic.molunerfinn.com/picgo/docs/logo-150.png" referrerpolicy="no-referrer" alt="Images"/><span class="back-menu-item-text">Images</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.calyee.top/" title="个人首页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog.calyee.top/favicon.svg" alt="个人首页"/><span class="back-menu-item-text">个人首页</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">工具</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://www.iconfont.cn/" title="阿里巴巴图标库"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://api.iowen.cn/favicon/www.iconfont.cn/.png" referrerpolicy="no-referrer" alt="阿里巴巴图标库"/><span class="back-menu-item-text">阿里巴巴图标库</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://cli.im/" title="草料二维码"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://ts4.cn.mm.bing.net/th?id=ODLS.28ebe3ec-525b-4152-bbd7-ec81168c5e0f&amp;w=32&amp;h=32&amp;qlt=90&amp;pcl=fffffa&amp;o=6&amp;pid=1.2" referrerpolicy="no-referrer" alt="草料二维码"/><span class="back-menu-item-text">草料二维码</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/games/"><i class="anzhiyufont anzhiyu-icon-keyboard faa-tada" style="font-size: 0.9em;"></i><span> 我的游戏</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/todolist/"><i class="anzhiyufont anzhiyu-icon-copy faa-tada" style="font-size: 0.9em;"></i><span> 待办清单</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size: 0.9em;"></i><span> 我的装备</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Docker/" style="font-size: 0.88rem; color: rgb(49, 9, 24);">Docker<sup>1</sup></a><a href="/tags/Dubbo/" style="font-size: 0.88rem; color: rgb(126, 186, 127);">Dubbo<sup>1</sup></a><a href="/tags/Hexo%E9%AD%94%E6%94%B9/" style="font-size: 0.88rem; color: rgb(21, 56, 109);">Hexo魔改<sup>2</sup></a><a href="/tags/JVM/" style="font-size: 0.88rem; color: rgb(110, 10, 12);">JVM<sup>1</sup></a><a href="/tags/Java/" style="font-size: 0.88rem; color: rgb(195, 151, 95);">Java<sup>6</sup></a><a href="/tags/Jenkins/" style="font-size: 0.88rem; color: rgb(2, 158, 46);">Jenkins<sup>1</sup></a><a href="/tags/MyBatis/" style="font-size: 0.88rem; color: rgb(156, 11, 20);">MyBatis<sup>2</sup></a><a href="/tags/MyBatisPlus/" style="font-size: 0.88rem; color: rgb(167, 36, 84);">MyBatisPlus<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 0.88rem; color: rgb(195, 128, 118);">MySQL<sup>1</sup></a><a href="/tags/Netty/" style="font-size: 0.88rem; color: rgb(156, 14, 3);">Netty<sup>2</sup></a><a href="/tags/Nginx/" style="font-size: 0.88rem; color: rgb(77, 184, 131);">Nginx<sup>1</sup></a><a href="/tags/RabbitMQ/" style="font-size: 0.88rem; color: rgb(7, 182, 118);">RabbitMQ<sup>1</sup></a><a href="/tags/Redis/" style="font-size: 0.88rem; color: rgb(17, 118, 120);">Redis<sup>1</sup></a><a href="/tags/Spring/" style="font-size: 0.88rem; color: rgb(190, 105, 30);">Spring<sup>2</sup></a><a href="/tags/SpringBoot/" style="font-size: 0.88rem; color: rgb(25, 20, 137);">SpringBoot<sup>1</sup></a><a href="/tags/SpringCloud/" style="font-size: 0.88rem; color: rgb(95, 126, 89);">SpringCloud<sup>2</sup></a><a href="/tags/SpringMVC/" style="font-size: 0.88rem; color: rgb(137, 129, 120);">SpringMVC<sup>1</sup></a><a href="/tags/SpringSecurity/" style="font-size: 0.88rem; color: rgb(120, 41, 160);">SpringSecurity<sup>1</sup></a><a href="/tags/Vue/" style="font-size: 0.88rem; color: rgb(135, 74, 77);">Vue<sup>1</sup></a><a href="/tags/WebSocket/" style="font-size: 0.88rem; color: rgb(105, 105, 88);">WebSocket<sup>2</sup></a><a href="/tags/Zookeeper/" style="font-size: 0.88rem; color: rgb(81, 97, 3);">Zookeeper<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 0.88rem; color: rgb(143, 149, 137);">分布式<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 0.88rem; color: rgb(100, 97, 50);">分布式锁<sup>1</sup></a><a href="/tags/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/" style="font-size: 0.88rem; color: rgb(169, 137, 10);">反向代理<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 0.88rem; color: rgb(161, 9, 22);">后端<sup>5</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 0.88rem; color: rgb(4, 160, 114);">多线程<sup>1</sup></a><a href="/tags/%E5%AE%B9%E5%99%A8/" style="font-size: 0.88rem; color: rgb(62, 105, 63);">容器<sup>1</sup></a><a href="/tags/%E5%BA%95%E5%B1%82/" style="font-size: 0.88rem; color: rgb(200, 78, 59);">底层<sup>1</sup></a><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 0.88rem; color: rgb(130, 97, 98);">微服务<sup>1</sup></a><a href="/tags/%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem; color: rgb(47, 22, 68);">总结<sup>2</sup></a><a href="/tags/%E6%A8%A1%E6%9D%BF%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 0.88rem; color: rgb(175, 145, 33);">模板数据库<sup>1</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 0.88rem; color: rgb(150, 192, 128);">消息队列<sup>1</sup></a><a href="/tags/%E6%B8%B8%E6%A0%87%E7%BF%BB%E9%A1%B5/" style="font-size: 0.88rem; color: rgb(45, 141, 39);">游标翻页<sup>1</sup></a><a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 0.88rem; color: rgb(188, 131, 33);">源码分析<sup>3</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem; color: rgb(60, 102, 127);">算法<sup>1</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 0.88rem; color: rgb(134, 111, 170);">线程池<sup>1</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 0.88rem; color: rgb(80, 25, 183);">设计模式<sup>2</sup></a><a href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" style="font-size: 0.88rem; color: rgb(79, 17, 119);">负载均衡<sup>2</sup></a><a href="/tags/%E9%A1%B9%E7%9B%AE/" style="font-size: 0.88rem; color: rgb(93, 117, 118);">项目<sup>3</sup></a></div></div><hr/></div></div><div id="keyboard-tips"><div class="keyboardTitle">博客快捷键</div><div class="keybordList"><div class="keybordItem"><div class="keyGroup"><div class="key">shift K</div></div><div class="keyContent"><div class="content">关闭快捷键功能</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift A</div></div><div class="keyContent"><div class="content">打开/关闭中控台</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift M</div></div><div class="keyContent"><div class="content">播放/暂停音乐</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift D</div></div><div class="keyContent"><div class="content">深色/浅色显示模式</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift S</div></div><div class="keyContent"><div class="content">站内搜索</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift R</div></div><div class="keyContent"><div class="content">随机访问</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift H</div></div><div class="keyContent"><div class="content">返回首页</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift F</div></div><div class="keyContent"><div class="content">友链鱼塘</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift L</div></div><div class="keyContent"><div class="content">友链页面</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift P</div></div><div class="keyContent"><div class="content">关于本站</div></div></div><div class="keybordItem"><div class="keyGroup"><div class="key">shift I</div></div><div class="keyContent"><div class="content">原版/本站右键菜单</div></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8008731670" server="tencent" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8008731670&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.20/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.4/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>var meting_api = "https://meting.qjqq.cn/?server=tencent&type=playlist&id=8008731670&r=playlist";
</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("9/9/2023 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2023 By 安知鱼 V1.6.8",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Calyee 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("9/9/2023 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      img.src = "/img/badge/calyee-下班啦.svg";
      img.title = "休息喽~";
      img.alt = "休息喽~";

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.56.5/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://comment.calyee.top/',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.21/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://comment.calyee.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://comment.calyee.top/',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.21/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script>(function(){var bp = document.createElement('script');var curProtocol = window.location.protocol.split(':')[0];if (curProtocol === 'https') {bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';}else {bp.src = 'http://push.zhanzhang.baidu.com/push.js';}var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp, s);})();</script><script async data-pjax src="/js/imgloaded.js?1"></script><script async data-pjax src="/js/welcome.js?1"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><!-- hexo injector body_end start -->
  <script data-pjax src="https://fastly.jsdelivr.net/npm/hexo-get-github-contribute@1.0.1/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://github-contribute.calyee.top/api?user=yikoutian1";
            var git_color =['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'];
            var git_user ="user=yikoutian1";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="height:100%;display: flex;align-items: center;justify-content: center;"><svg style="height:50px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/'){
                console.log('已挂载github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:248px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><!-- hexo injector body_end end --></body></html>